{% extends "base.html" %}
{% block title %}LuftDocs - In√≠cio{% endblock %}

{% block content %}
<style>
    /* Fundo animado com gradiente */
    body {
        background: linear-gradient(120deg, #e0e7ff 0%, #f9f9fb 100%);
        background-size: 200% 200%;
        animation: bgMove 12s ease-in-out infinite;
        perspective: 1500px;
    }
    @keyframes bgMove {
        0%   { background-position: 0% 50%; }
        50%  { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    body.theme-dark {
        background: linear-gradient(120deg, #23263b 0%, #1e1e2f 100%);
        background-size: 200% 200%;
        animation: bgMove 12s ease-in-out infinite;
    }

    /* Modern Card Animations */
    .modern-card {
        min-height: 370px;
        max-height: 370px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-radius: 1.25rem;
        transition: box-shadow 0.3s cubic-bezier(.4,2,.3,1), border-color 0.2s, transform 0.25s;
        border: 1.5px solid #e3e6ed;
        background: #fff;
        box-shadow: 0 2px 8px rgba(80, 120, 200, 0.08);
        opacity: 0;
        transform: translateY(40px) scale(0.97);
        animation: cardFadeIn 0.7s forwards;
        animation-delay: calc(var(--card-index) * 0.08s);
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    @keyframes cardFadeIn {
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .modern-card::after {
        content: "";
        position: absolute;
        top: -80px; left: -80px;
        width: 160px; height: 160px;
        background: radial-gradient(circle, #b6d0ff55 40%, transparent 80%);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s;
        z-index: 2;
    }
    .modern-card:hover::after {
        opacity: 0.7;
        animation: shine 1.2s linear;
    }
    @keyframes shine {
        0%   { transform: scale(0.8) rotate(0deg); }
        100% { transform: scale(1.2) rotate(30deg); }
    }
    body.theme-dark .modern-card {
        background: #23263b;
        box-shadow: 0 2px 16px rgba(13,110,253,0.10), 0 2px 12px rgba(0,0,0,0.28) !important;
        border-color: #23263b !important;
    }
    body.theme-dark .modern-card:hover {
        box-shadow: 0 12px 36px rgba(13,110,253,0.18), 0 2px 8px rgba(0,0,0,0.18) !important;
        border-color: #0d6efd !important;
    }
    .modern-card:hover {
        box-shadow: 0 16px 48px rgba(80, 120, 200, 0.22), 0 2px 8px rgba(80, 120, 200, 0.04);
        border-color: #0d6efd;
        transform: translateY(-8px) scale(1.04) rotate(-1deg);
    }
    .modern-card .display-4 {
        transition: transform 0.3s cubic-bezier(.4,2,.3,1), color 0.2s;
        filter: drop-shadow(0 2px 8px #0d6efd22);
        animation: pulseIcon 2.2s infinite;
    }
    .modern-card:hover .display-4 {
        transform: scale(1.18) rotate(6deg);
        color: #0d6efd;
        filter: drop-shadow(0 4px 16px #0d6efd44);
        animation: pulseIconHover 0.8s;
    }
    @keyframes pulseIcon {
        0%,100% { transform: scale(1); }
        50%      { transform: scale(1.08); }
    }
    @keyframes pulseIconHover {
        0%   { transform: scale(1.18) rotate(6deg); }
        50%  { transform: scale(1.28) rotate(8deg); }
        100% { transform: scale(1.18) rotate(6deg); }
    }

    /* Ripple nos bot√µes */
    .modern-btn {
        min-width: 140px;
        margin: 0.25rem;
        font-weight: 500;
        border-radius: 2rem;
        transition: background 0.15s, color 0.15s, box-shadow 0.2s;
        box-shadow: 0 1px 4px rgba(13,110,253,0.04);
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    .modern-btn:active::after {
        content: "";
        position: absolute;
        left: 50%; top: 50%;
        width: 0; height: 0;
        background: rgba(13,110,253,0.18);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: ripple 0.5s linear;
        z-index: 2;
    }
    @keyframes ripple {
        to {
            width: 220px;
            height: 220px;
            opacity: 0;
        }
    }

    /* --- √çcones decorativos flutuantes (CSS CORRIGIDO) --- */
    .bg-icons {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        pointer-events: none;
        overflow: hidden;
        z-index: 0;
    }

    /* A anima√ß√£o agora √© aplicada diretamente na classe principal .bg-icon */
    .bg-icons .bg-icon {
        position: absolute;
        color: rgba(13,110,253,0.13);
        bottom: -2rem; /* Posi√ß√£o inicial para a anima√ß√£o cl√°ssica */
        
        /* Propriedades da anima√ß√£o cl√°ssica */
        animation-name: iconRise;
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
    }

    body.theme-dark .bg-icons .bg-icon {
        color: rgba(255,255,255,0.13);
    }
    
    @keyframes iconRise {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 1;
        }
        50% {
            transform: translateY(-50vh) rotate(180deg);
            opacity: 0.7;
        }
        100% {
            transform: translateY(-100vh) rotate(360deg);
            opacity: 0;
        }
    }

    /* Restante dos estilos originais de cards e bot√µes */
    .modern-card .card-body {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1;
        position: relative;
    }
    .modern-card .card-title {
        color: var(--primary-accent-color, #0d6efd);
        font-size: 1.15rem;
        margin-bottom: 1.2rem;
        letter-spacing: 0.01em;
        font-weight: 600;
        transition: color 0.2s;
    }
    .modern-card:hover .card-title {
        color: #0d6efd;
        text-shadow: 0 2px 12px #b6d0ff55;
    }
    .modern-card .card-text {
        color: #6c757d;
        font-size: 0.98rem;
        text-align: center;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }
    .modern-card:hover .card-text {
        color: #495057;
    }
    .modern-btn i {
        margin-right: 0.4em;
        transition: transform 0.2s;
    }
    .modern-btn:hover i {
        transform: translateY(-2px) scale(1.1) rotate(-8deg);
    }
    .modern-btn:active {
        box-shadow: 0 0 0 2px #0d6efd33;
    }
    .add-new-card {
        background: transparent !important;
        border: 2px dashed var(--border-color, #ced4da) !important;
        color: #6c757d !important;
        box-shadow: none !important;
        transition: border-color 0.2s, color 0.2s, background 0.2s;
    }
    .add-new-card:hover {
        border-color: #0d6efd !important;
        color: #0d6efd !important;
        background: #f8f9fa !important;
    }

    body.page-transition-out .container {
        transform: rotateY(-90deg) scale(0.9);
        opacity: 0;
        transition: transform 1s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.8s ease-out;
    }

    body.theme-dark .add-new-card {
        background: transparent !important;
        border-color: #23263b !important;
        color: #b6d0ff !important;
    }
    body.theme-dark .add-new-card:hover {
        border-color: #0d6efd !important;
        color: #0d6efd !important;
        background: #23263b !important;
    }
    @media (max-width: 575px) {
        .modern-card {
            min-height: 320px;
            max-height: 320px;
        }
    }

</style>

<div class="bg-icons"></div>

<div class="container my-5 position-relative" style="z-index:2;">
    <div class="mb-4 text-end d-flex justify-content-end gap-2">
            <a href="{{ url_for('index.mapa_conhecimento', token=request.args.get('token')) }}" id="switchToMapViewBtn" class="btn btn-primary modern-btn">
                <i class="bi bi-diagram-3"></i> Ver Mapa
            </a>
        {% if can_access_editor %}
            {# --- CORRE√á√ÉO: Endpoint correto e adi√ß√£o do token --- #}
            <a href="{{ url_for('editor.editor_index', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn">
                <i class="bi bi-pencil-square"></i> Acessar editor de conte√∫dos
            </a>
        {% endif %}
        {% if can_access_permissions_menu %}
             {# --- CORRE√á√ÉO: Adi√ß√£o do token --- #}
            <a href="{{ url_for('permissions.manage_permissions', token=request.args.get('token')) }}" class="btn btn-outline-dark modern-btn">
                <i class="bi bi-shield-lock"></i> Gerenciar permiss√µes
            </a>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="Title mb-0">M√≥dulos do LuftDocs</h1>
        <div class="position-relative" style="min-width: 250px;">
            <input type="text" id="filterInput" class="form-control ps-4" placeholder="Filtrar m√≥dulos...">
            <i class="bi bi-search position-absolute top-50 translate-middle-y" style="left: 5px; color: #6c757d;"></i>
        </div>
    </div>

    <div class="row g-4" id="modules-row">
        {% for m in modulos %}
            {% if m.has_content or can_view_tecnico %}
                <div class="col-12 col-sm-6 col-md-4 d-flex module-card-wrapper">
                    <div class="card modern-card w-100 shadow-sm border-0" style="--card-index: {{ loop.index0 }}">
                        <div class="card-body">
                            <i class="bi {{ m['icone'] }} display-4 text-primary mb-3"></i>
                            <h5 class="card-title">{{ m['nome'] }}</h5>
                            <p class="card-text">{{ m['descricao'] }}</p>
                        </div>
                        <div class="pb-3 text-center">
                            {% if m.has_content %}
                                {# --- CORRE√á√ÉO: Endpoint correto para 'modulo' e adi√ß√£o do token --- #}
                                <a class="btn btn-outline-primary modern-btn me-2" href="{{ url_for('modulo.ver_modulo_pela_raiz', modulo=m['id'], token=request.args.get('token')) }}">
                                    <i class="bi bi-search"></i> Ver m√≥dulo
                                </a>
                            {% endif %}
                            {% if can_view_tecnico %}
                                {# --- CORRE√á√ÉO: Endpoint correto para 'modulo' e adi√ß√£o do token --- #}
                                <a class="btn btn-outline-secondary modern-btn ms-2" href="{{ url_for('modulo.ver_modulo_pela_raiz', modulo_tecnico=m['id'], token=request.args.get('token')) }}">
                                    <i class="bi bi-tools"></i> M√≥dulo T√©cnico
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        {% if can_create_modules %}
        <div class="col-12 col-sm-6 col-md-4 d-flex module-card-wrapper">
            {# --- CORRE√á√ÉO: Endpoint para 'editor' e adi√ß√£o do token --- #}
            <a href="{{ url_for('editor.criar_modulo', token=request.args.get('token')) }}" class="card modern-card add-new-card w-100 shadow-none border-0 text-decoration-none" style="--card-index: {{ modulos|length }}">
                <div class="card-body d-flex flex-column align-items-center justify-content-center" style="flex:1;">
                    <i class="bi bi-plus-circle-dotted display-4 mb-3"></i>
                    <h5 class="card-title">Criar Novo M√≥dulo</h5>
                </div>
            </a>
        </div>
        {% endif %}
        
        <div id="no-results-message" class="col-12 text-center py-5" style="display: none;">
            <i class="bi bi-emoji-frown fs-1 text-muted"></i>
            <h4 class="mt-3">Nenhum m√≥dulo encontrado</h4>
            <p class="text-muted">Tente ajustar os termos da sua busca.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterInput = document.getElementById('filterInput');
    const modulesRow = document.getElementById('modules-row');
    const moduleCards = Array.from(document.querySelectorAll('.module-card-wrapper')); // Convert NodeList to Array
    const noResultsMessage = document.getElementById('no-results-message');

    filterInput.addEventListener('input', () => {
        const filterText = filterInput.value.toLowerCase().trim();
        let visibleCardsCount = 0;
        const similarCards = [];
        const matchingCards = [];
        const otherCards = [];

        moduleCards.forEach(cardWrapper => {
            const titleElement = cardWrapper.querySelector('.card-title');
            const descriptionElement = cardWrapper.querySelector('.card-text');

            if (titleElement && descriptionElement) {
                const title = titleElement.textContent.toLowerCase();
                const description = descriptionElement.textContent.toLowerCase();
                const fullText = `${title} ${description}`;

                cardWrapper.style.display = 'none'; // Initially hide all cards
                cardWrapper.style.visibility = 'hidden';

                if (filterText === "") {
                    otherCards.push(cardWrapper);
                    visibleCardsCount++;
                } else if (fullText.includes(filterText)) {
                    matchingCards.push(cardWrapper);
                    visibleCardsCount++;
                } else if (fullText.split(" ").some(word => filterText.split(" ").includes(word) && word.length > 2)) { // Check for similar words (longer than 2 letters)
                    similarCards.push(cardWrapper);
                    visibleCardsCount++;
                } else {
                    otherCards.push(cardWrapper);
                }
            }
        });

        // Clear the current order
        modulesRow.innerHTML = '';

        // Append similar cards, then matching cards, then the rest
        [...similarCards, ...matchingCards, ...otherCards].forEach(card => {
            modulesRow.appendChild(card);
            if (filterText === "" || similarCards.includes(card) || matchingCards.includes(card)) {
                card.style.display = 'flex';
                card.style.visibility = 'visible';
            }
        });

        if (visibleCardsCount === 0 && filterText !== "") {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    });
    // NOVO C√ìDIGO PARA TRANSI√á√ÉO DE P√ÅGINA
    const switchToMapBtn = document.getElementById('switchToMapViewBtn');
    if (switchToMapBtn) {
        switchToMapBtn.addEventListener('click', (event) => {
            // 1. Impedir a navega√ß√£o imediata para dar tempo para a anima√ß√£o
            event.preventDefault(); 
            
            // 2. Guardar a URL de destino
            const destinationUrl = switchToMapBtn.href;
            
            // 3. Adicionar a classe que dispara a anima√ß√£o de sa√≠da no CSS
            document.body.classList.add('page-transition-out');
            
            // 4. Aguardar o fim da anima√ß√£o (400ms) e ent√£o redirecionar
            setTimeout(() => {
                window.location.href = destinationUrl;
            }, 1000); 
        });
    }
});

// =========================================================================
// L√ìGICA ORIGINAL DA ANIMA√á√ÉO DE FUNDO (n√£o modificada)
// =========================================================================
const container = document.querySelector('.bg-icons');
let animationFrameId = null;

function getAnimationParameters() {
    const quantity = parseInt(localStorage.getItem('ld_bg_quantity') || '50', 10);
    const speedFactor = parseFloat(localStorage.getItem('ld_bg_speed') || '1.0');
    const randomnessFactor = 1 + (speedFactor - 1) * 0.5;
    return { quantity, speedFactor, randomnessFactor };
}

function iniciarAnimacaoComColisao() {
    const { quantity, speedFactor, randomnessFactor } = getAnimationParameters();
    const iconsData = [];
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;

    fetch('{{ url_for("static", filename="data/icons.json") }}')
        .then(res => res.json())
        .then(availableIcons => {
            for (let i = 0; i < quantity; i++) {
                const el = document.createElement('i');
                const size = (Math.random() * 32 * randomnessFactor + 16);

                el.className = `bi ${availableIcons[Math.floor(Math.random() * availableIcons.length)]} bg-icon`;
                el.style.fontSize = `${size}px`;
                el.style.animation = 'none';
                el.style.bottom = 'auto';

                container.appendChild(el);

                iconsData.push({
                    element: el,
                    x: Math.random() * (screenWidth - size),
                    y: Math.random() * (screenHeight - size),
                    dx: (Math.random() - 0.5) * 1.5 * speedFactor,
                    dy: (Math.random() - 0.5) * 1.5 * speedFactor,
                    size: size
                });
            }
            animate();
        })
        .catch(console.error);

    function animate() {
        iconsData.forEach((icon, index) => {
            icon.x += icon.dx;
            icon.y += icon.dy;
            if (icon.x <= 0 || icon.x + icon.size >= screenWidth) { icon.dx *= -1; }
            if (icon.y + icon.size >= screenHeight) { icon.dy *= -1; }
            for (let i = index + 1; i < iconsData.length; i++) {
                const otherIcon = iconsData[i];
                const dist_x = (icon.x + icon.size / 2) - (otherIcon.x + otherIcon.size / 2);
                const dist_y = (icon.y + icon.size / 2) - (otherIcon.y + otherIcon.size / 2);
                const distance = Math.sqrt(dist_x * dist_x + dist_y * dist_y);
                const minDistance = (icon.size / 2) + (otherIcon.size / 2);
                if (distance < minDistance) {
                    [icon.dx, otherIcon.dx] = [otherIcon.dx, icon.dx];
                    [icon.dy, otherIcon.dy] = [otherIcon.dy, icon.dy];
                }
            }
            icon.element.style.transform = `translate(${icon.x}px, ${icon.y}px)`;
        });
        animationFrameId = requestAnimationFrame(animate);
    }
}

function iniciarAnimacaoOriginal() {
    const { quantity, speedFactor, randomnessFactor } = getAnimationParameters();

    fetch('{{ url_for("static", filename="data/icons.json") }}')
        .then(res => res.json())
        .then(icons => {
            for (let i = 0; i < quantity; i++) {
                const cls = icons[Math.floor(Math.random() * icons.length)];
                const el = document.createElement('i');
                el.className = `bi ${cls} bg-icon`;

                el.style.fontSize = `${(Math.random() * 2 * randomnessFactor + 1).toFixed(2)}rem`;
                el.style.left = `${Math.random() * 100}%`;
                el.style.animationDelay = `${(Math.random() * 5).toFixed(2)}s`;

                const baseDuration = 10 + Math.random() * 10;
                el.style.animationDuration = `${(baseDuration / speedFactor).toFixed(2)}s`;

                container.appendChild(el);
            }
        })
        .catch(console.error);
}

window.mudarAnimacao = function(modo) {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    container.innerHTML = '';

    if (modo === 'original') {
        iniciarAnimacaoOriginal();
    } else {
        iniciarAnimacaoComColisao();
    }
}

const savedAnimation = localStorage.getItem('ld_bgAnimation') || 'colisao';
mudarAnimacao(savedAnimation);

const switchToMapBtn = document.getElementById('switchToMapViewBtn');
if (switchToMapBtn) {
    switchToMapBtn.addEventListener('click', (event) => {
        event.preventDefault(); 
        const destinationUrl = switchToMapBtn.href;
        document.body.classList.add('page-transition-out');
        
        // üîÑ ALTERADO: Ajuste o tempo para corresponder √† nova dura√ß√£o da anima√ß√£o CSS
        setTimeout(() => {
            window.location.href = destinationUrl;
        }, 600); // 600ms = 0.6s
    });
}
</script>
{% endblock %}