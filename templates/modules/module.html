{% extends "base.html" %}
{% block title %}{{ modulo.nome }} - LuftDocs{% endblock %}

{% block content %}
<style>
    tbody, td, tfoot, th, thead, tr{
    color: white;
    }
    
    /* --- Estilos do Cabe√ßalho e Busca --- */
    .module-header {
        text-align: center;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 2rem;
        position: relative;
        padding-left: 95px;     
    }
    body.theme-dark .module-header {
        border-bottom-color: #343a40;
    }
    .module-header h1 .icon-title {
        color: var(--primary-color, #0d6efd);
        margin-right: 0.5rem;
    }

    .header-back-button {
    position: absolute;
    top: 0;
    left: 0;
    }
    .module-description {
        font-size: 1.1rem;
        color: #6c757d;
        max-width: 700px;
        margin: 0.5rem auto 1.5rem auto;
    }
    body.theme-dark .module-description {
        color: #adb5bd;
    }
    .search-in-module-container {
        max-width: 500px;
        margin: 0 auto;
    }
    .search-form {
        position: relative;
        display: flex;
        align-items: center;
    }
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        padding-right: 3rem; 
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 50px;
        transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }
    .search-input:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
    }
    body.theme-dark .search-input {
        background-color: #2c2c2c;
        border-color: #555;
        color: #f1f1f1;
    }
    .search-button {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        padding: 0.5rem 0.8rem;
        cursor: pointer;
        color: #6c757d;
    }
    body.theme-dark .search-button {
        color: #adb5bd;
    }

    /* --- Estilos de Destaque e Autocomplete (Mantidos) --- */
    .markdown-body mark  {
        background-color: #FFDC74;
        color: #1c1c1c;
        font-weight: 600;
        padding: 0.1em 0.3em;
        margin: 0 -0.3em;
        border-radius: 4px;
        box-decoration-break: clone;
        -webkit-box-decoration-break: clone;
    }
    .autocomplete-list {
        position: absolute;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        z-index: 1000;
        width: 100%;
        max-width: 400px;
        margin-top: 5px;
        padding: 0;
        list-style: none;
        display: none;
    }
    .autocomplete-list li {
        padding: 8px 16px;
        cursor: pointer;
        transition: background 0.15s;
        color: #333;
    }
    .autocomplete-list li:hover, .autocomplete-list li.active {
        background: #e6f7ff;
    }

    .meta-info{
        justify-content: left;
    }
    
    body.theme-dark .autocomplete-list {
        background: #2d2d2d;
        border-color: #444;
    }
    body.theme-dark .autocomplete-list li {
        color: #f1f1f1;
    }
    body.theme-dark .autocomplete-list li:hover,
    body.theme-dark .autocomplete-list li.active {
        background: #3a3a3a;
    }

    /* --- Estilos do Conte√∫do Markdown (Mantidos) --- */
    .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
        color: #1e1e1e;
        background-color: transparent;
    }
    
    body.theme-dark .markdown-body {
        color: white;
    }
    .markdown-body table {
        border-radius: 10px;
    }
    tbody, td, tfoot, th, thead, tr{
        color: white;
        background-color: black;
    }

    body.theme-dark .markdown-body tbody,
    body.theme-dark .markdown-body td,
    body.theme-dark .markdown-body tfoot,
    body.theme-dark .markdown-body th,
    body.theme-dark .markdown-body thead,
    body.theme-dark .markdown-body tr {
        color: rgb(0, 0, 0);
        background-color: white;
    }
    .markdown-body ol ol,
    .markdown-body ul ol {
        list-style-type: upper-roman;
    }
    .markdown-body ol ol li::marker,
    .markdown-body ul ol li::marker {
        font-weight: bold;
    }
    @media (max-width: 767px) {
        .markdown-body {
            padding: 15px;
        }
    }
</style>

    <div class="module-container">
        <div class="module-header">

            <h1><i class="{{ modulo.icon }} icon-title"></i> {{ modulo.nome }}</h1>
            <p class="module-description">{{ modulo.descricao }}</p>


            <div class="search-in-module-container">
                <form method="GET" action="{{ request.path }}" class="search-form">
                    {% if request.args.get('modulo') %}
                        <input type="hidden" name="modulo" value="{{ request.args.get('modulo') }}">
                    {% elif request.args.get('modulo_tecnico') %}
                        <input type="hidden" name="modulo_tecnico" value="{{ request.args.get('modulo_tecnico') }}">
                    {% endif %}
                    
                    <input type="hidden" name="token" value="{{ request.args.get('token', '') }}">
                    <input type="search" id="busca-input" name="q" value="{{ query or '' }}" placeholder="Buscar em {{ modulo.nome }}..." class="search-input" autocomplete="off">
                    <button type="submit" class="search-button" aria-label="Buscar">
                        <i class="fas fa-search"></i>
                    </button>

                    <ul id="autocomplete-list" class="autocomplete-list"></ul>
                </form>
            </div>
        </div>
    </div>
    <div class="markdown-body">
        {% if resultado_highlight %}
            <div class="alert alert-info">
                Mostrando resultados para: <strong>{{ query }}</strong>
            </div>
        {% endif %}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container" style="position: relative; z-index: 1050;">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}
        <div class="modulo-conteudo" id="imagem-viewer">
            {% set html_bruto = conteudo %}
            {% set conteudo_com_token = html_bruto.replace("__TOKEN_PLACEHOLDER__", request.args.get('token', '')) %}
            {% set prefix = '/downloads/docs/' %}
            {% set replace_prefix = url_for('download.download_pela_raiz', token=request.args.get('token', '')) ~ '&file=' %}
            {% set conteudo_final = conteudo_com_token.replace('href="' ~ prefix, 'href="' ~ replace_prefix) %}
            {{ conteudo_final | safe }}
        </div>
    </div>
    <a href="{{ url_for('evaluation.evaluation', document_id=id_do_modulo, token=token) }}" class="btn btn-primary">Avaliar</a>
    {% if relacionados %}
    <hr>
    <div class="related-modules-container" style="max-width: 980px; margin: 2rem auto; padding: 0 20px;">
        <h3 class="mb-3">M√≥dulos Relacionados</h3>
        <div class="relacionados mb-4">
            {% for rel in relacionados %}
                <a class="btn btn-outline-primary btn-sm me-1 mb-1"
                   href="{{ url_for('modulo.ver_modulo_pela_raiz', **{'token': request.args.get('token'), 'modulo': rel.id}) }}">
                    <i class="bi {{ rel.icone }}"></i> {{ rel.nome }}
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Modal para Imagens -->
    <div class="modal fade" id="imagemModal" tabindex="-1" aria-labelledby="imagemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark border-0">
        <div class="modal-body text-center p-0">
            <img id="imagemExpandida"
                src=""
                alt="Imagem ampliada"
                style="width:100%; height:auto; max-height:85vh; border-radius: 8px;">
        </div>
        </div>
    </div>
    </div>
</div>
{% if versao_info and versao_info.versao_atual != "N/A" %}
<div class="meta-info" style="color: #adb5bd; font-size: 0.9em; margin-bottom: 220px; text-align: right;">

    {# 1. Exibe a vers√£o atual do documento #}
    <span>
        <i class="fas fa-tag"></i> 
        <strong>Vers√£o:</strong> {{ versao_info.versao_atual }}
    </span>

    {# 2. Exibe o usu√°rio que editou esta vers√£o #}
    <span style="margin-left: 15px;">
        <i class="fas fa-user-edit"></i> 
        <strong>Editado por:</strong> {{ versao_info.editor }}
    </span>

    {# 3. Exibe a data em que esta vers√£o foi aprovada #}
    <span style="margin-left: 15px;">
        <i class="fas fa-calendar-check"></i> 
        <strong>Aprovado em:</strong> {{ versao_info.data_aprovacao }}
    </span>

</div>
{% endif %}

<script>
// Zoom de Imagem
document.addEventListener('DOMContentLoaded', () => {
  // Seleciona todas as imagens dentro do seu conte√∫do
  document.querySelectorAll('.markdown-body img').forEach(img => {
    img.style.cursor = 'pointer';  // mostra que √© clic√°vel
    img.addEventListener('click', () => {
      // Define a mesma src da imagem clicada no modal
      document.getElementById('imagemExpandida').src = img.src;
      // Instancia e exibe o modal
      const modal = new bootstrap.Modal(document.getElementById('imagemModal'));
      modal.show();
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- L√≥gica de Autocomplete (Mantida) ---
    const buscaInput = document.getElementById('busca-input');
    const autocompleteList = document.getElementById('autocomplete-list');
    let currentFocus = -1;

    buscaInput.addEventListener('input', function() {
        const val = this.value;
        if (val.length < 2) {
            autocompleteList.style.display = 'none';
            return;
        }
        // ATEN√á√ÉO: Substitua pela sua rota de API real para o autocomplete
        fetch(`/api/autocomplete?q=${encodeURIComponent(val)}`)
            .then(response => response.json())
            .then(sugestoes => {
                autocompleteList.innerHTML = '';
                if (sugestoes.length === 0) {
                    autocompleteList.style.display = 'none';
                    return;
                }
                sugestoes.forEach((s) => {
                    const li = document.createElement('li');
                    li.textContent = s;
                    li.onclick = () => {
                        buscaInput.value = s;
                        autocompleteList.style.display = 'none';
                        buscaInput.form.submit();
                    };
                    autocompleteList.appendChild(li);
                });
                autocompleteList.style.display = 'block';
                currentFocus = -1;
            }).catch(() => {
                autocompleteList.style.display = 'none';
            });
    });

    buscaInput.addEventListener('keydown', function(e) {
        let items = autocompleteList.getElementsByTagName('li');
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
            currentFocus++;
            addActive(items);
        } else if (e.key === 'ArrowUp') {
            currentFocus--;
            addActive(items);
        } else if (e.key === 'Enter') {
            if (currentFocus > -1) {
                e.preventDefault();
                items[currentFocus].click();
            }
        }
    });

    function addActive(items) {
        if (!items) return;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add('active');
    }

    function removeActive(items) {
        for (let item of items) {
            item.classList.remove('active');
        }
    }

    document.addEventListener('click', function(e) {
        if (!autocompleteList.contains(e.target) && e.target !== buscaInput) {
            autocompleteList.style.display = 'none';
        }
    });

    // --- L√ìGICA DE ROLAGEM E NAVEGA√á√ÉO ENTRE DESTAQUES ---

    const marks = document.querySelectorAll('.markdown-body mark');
    let currentMarkIndex = 0;

    // S√≥ executa a l√≥gica se houver resultados da busca (tags <mark>)
    if (marks.length > 0) {
        
        // Fun√ß√£o para rolar e destacar a marca√ß√£o atual
        function scrollToMark(index) {
            // Remove o destaque da marca√ß√£o anterior
            marks.forEach(mark => mark.classList.remove('current-mark'));
            
            // Adiciona o destaque na marca√ß√£o atual
            const currentMark = marks[index];
            currentMark.classList.add('current-mark');
            
            // Rola a tela at√© a marca√ß√£o
            currentMark.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Rola para a primeira marca√ß√£o ao carregar a p√°gina
        scrollToMark(currentMarkIndex);

        // Adiciona o listener de eventos de teclado no documento inteiro
        document.addEventListener('keydown', function(e) {
            // Navega para o pr√≥ximo com "Enter"
            if (e.key === 'Enter') {
                // Previne o comportamento padr√£o (ex: submeter um formul√°rio)
                e.preventDefault();

                // Evita que a navega√ß√£o funcione enquanto digita no campo de busca
                if (document.activeElement === buscaInput) {
                    return;
                }

                // Avan√ßa para o pr√≥ximo √≠ndice, voltando ao in√≠cio se chegar ao fim
                currentMarkIndex = (currentMarkIndex + 1) % marks.length;
                scrollToMark(currentMarkIndex);
            }

            // Limpa a busca com "Esc"
            if (e.key === 'Escape') {
                e.preventDefault();
                
                // Cria uma URL baseada na atual
                const url = new URL(window.location.href);
                // Remove o par√¢metro de busca 'q'
                url.searchParams.delete('q');
                // Redireciona para a p√°gina sem a busca, limpando os destaques
                window.location.href = url.toString();
            }
        });
    }
});
</script>
{# ====================================================================== #}
{# NOVA L√ìGICA DO ASSISTENTE PROATIVO #}
{# ====================================================================== #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (typeof initializeProactiveAssistant === 'function') {

        // "banco de frases" para a Lia.
        const possibleMessages = [
            {
                toast: "Psiu! Quer uma ajuda?",
                modal: "Ol√°! üëã Notei que voc√™ est√° lendo sobre o m√≥dulo **{{ modulo.nome }}**. Posso te ajudar a encontrar uma informa√ß√£o espec√≠fica, fazer um resumo ou explicar algum t√≥pico?"
            },
            {
                toast: "Sabia que eu posso resumir?",
                modal: "Estou vendo que voc√™ est√° focado(a) em **{{ modulo.nome }}**. Que tal um resumo r√°pido dos pontos mais importantes para come√ßar?"
            },
            {
                toast: "Uma curiosidade sobre este m√≥dulo...",
                modal: "Uma curiosidade sobre **{{ modulo.nome }}**: ele tem links para **{{ relacionados|length }}** outros m√≥dulos! Quer que eu mostre quais s√£o ou procure por um t√≥pico espec√≠fico nele?"
            },
            {
                toast: "Encontrou o que procurava?",
                modal: "Ol√°! Se estiver com dificuldade para encontrar algo em **{{ modulo.nome }}**, √© s√≥ me avisar. Posso fazer uma busca inteligente para voc√™. üòâ"
            },
        ];
        
        // 2. O contexto agora passa a lista inteira de possibilidades.
        const proactiveContext = {
            type: 'module_page',
            moduleId: '{{ modulo.id }}',
            moduleName: '{{ modulo.nome }}',
            messages: possibleMessages // Passamos o array de mensagens
        };

        // 3. As configura√ß√µes do timer continuam as mesmas.
        const timerConfig = {
            timeout: 120000, // 2 minutos
            promptTimeout: 300000 // 5 minutos
        };

        // 4. Inicia o assistente com o novo contexto.
        initializeProactiveAssistant(proactiveContext, timerConfig);
    }
});
</script>
{% endblock %}