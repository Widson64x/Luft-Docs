<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA de Teste - LuftDocs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .card { margin-top: 2rem; }
        #spinner { display: none; }
        #context-files { font-size: 0.8rem; max-height: 150px; overflow-y: auto; background-color: #e9ecef; }
        #iaResponse ul { padding-left: 20px; margin-top: 10px;}
        #iaResponse li { margin-bottom: 5px; }
        #iaResponse h2 { font-size: 1.2rem; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #iaResponse img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #dee2e6; }
        .feedback-section { margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .feedback-buttons button { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header text-center bg-primary text-white">
                <h2>üß™ LIA IA (BETA)</h2>
            </div>
            <div class="card-body">
                <p class="card-text">A "Lia" agora l√™ todos os arquivos do projeto para criar o contexto. Fa√ßa sua pergunta abaixo!</p>

                <div class="mb-3">
                    <label for="userQuestion" class="form-label"><strong>Sua Pergunta:</strong></label>
                    <input type="text" class="form-control" id="userQuestion" placeholder="Ex: Como √© a tela do recebimento INTEC?">
                </div>

                <div class="mb-3">
                    <label for="modelSelector" class="form-label"><strong>Escolha o Modelo da IA:</strong></label>
                    <select class="form-select" id="modelSelector">
                        <option value="groq-70b" selected>Groq (Llama 3 70b - Poderoso)</option>
                        <option value="groq-8b">Groq (Llama 3 8b - Super R√°pido)</option>
                        <option value="gemini">Gemini (1.5 Flash - Google)</option>
                        <option value="openai" disabled>OpenAI (GPT-4o - Requer Cr√©dito)</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-success btn-lg" id="askButton">
                        <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Perguntar √† Lia
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <strong>Resposta da Lia:</strong>
                    </div>
                    <div class="card-body" id="iaResponse">
                        <p class="text-muted">A resposta aparecer√° aqui...</p>
                    </div>
                    <div class="card-footer" id="context-info" style="display: none;">
                        <small><strong>Contexto utilizado (arquivos lidos):</strong></small>
                        <div id="context-files" class="list-group list-group-flush p-2"></div>
                    </div>
                     <div class="card-footer feedback-section" id="feedbackSection" style="display: none;">
                        <small>Esta resposta foi √∫til?</small>
                        <div class="feedback-buttons mt-2">
                            <button class="btn btn-outline-success btn-sm" id="feedbackGood" data-rating="1">üëç Sim</button>
                            <button class="btn btn-outline-danger btn-sm" id="feedbackBad" data-rating="0">üëé N√£o</button>
                        </div>
                        <div class="mt-3" id="feedbackCommentArea" style="display: none;">
                            <textarea class="form-control" id="feedbackComment" rows="2" placeholder="Opcional: Deixe um coment√°rio para nos ajudar a melhorar..."></textarea>
                            <button class="btn btn-primary btn-sm mt-2" id="submitComment">Enviar Coment√°rio</button>
                        </div>
                        <div class="mt-2" id="feedbackMessage"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const askButton = document.getElementById('askButton');
        const userQuestionInput = document.getElementById('userQuestion');
        const modelSelector = document.getElementById('modelSelector');
        const iaResponseDiv = document.getElementById('iaResponse');
        const spinner = document.getElementById('spinner');
        const contextInfo = document.getElementById('context-info');
        const contextFilesDiv = document.getElementById('context-files');

        // NEW: Elementos de feedback
        const feedbackSection = document.getElementById('feedbackSection');
        const feedbackGoodBtn = document.getElementById('feedbackGood');
        const feedbackBadBtn = document.getElementById('feedbackBad');
        const feedbackCommentArea = document.getElementById('feedbackCommentArea');
        const feedbackCommentInput = document.getElementById('feedbackComment');
        const submitCommentBtn = document.getElementById('submitComment');
        const feedbackMessageDiv = document.getElementById('feedbackMessage');

        let currentResponseId = null;
        let currentUserId = null;
        let lastSubmittedRating = null; // Para rastrear a √∫ltima classifica√ß√£o enviada para o coment√°rio

        askButton.addEventListener('click', async () => {
            const userQuestion = userQuestionInput.value;
            const selectedModel = modelSelector.value;

            if (!userQuestion.trim()) {
                alert('Por favor, fa√ßa uma pergunta.');
                return;
            }

            spinner.style.display = 'inline-block';
            askButton.disabled = true;
            iaResponseDiv.innerHTML = `<p class="text-muted">A Lia est√° pensando com o motor do ${selectedModel.toUpperCase()}...</p>`;
            contextInfo.style.display = 'none';
            contextFilesDiv.innerHTML = '';
            feedbackSection.style.display = 'none'; // Esconde a se√ß√£o de feedback
            feedbackCommentArea.style.display = 'none'; // Esconde a √°rea de coment√°rio
            feedbackMessageDiv.textContent = ''; // Limpa mensagens anteriores
            feedbackGoodBtn.disabled = false; // Habilita bot√µes de feedback
            feedbackBadBtn.disabled = false;
            feedbackCommentInput.value = ''; // Limpa o campo de coment√°rio


            try {
                const response = await fetch('/api/ask_llm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_question: userQuestion,
                        selected_model: selectedModel
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    iaResponseDiv.innerHTML = marked.parse(data.answer);
                    if (data.context_files && data.context_files.length > 0) {
                        data.context_files.forEach(file => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'list-group-item py-1';
                            fileElement.textContent = file;
                            contextFilesDiv.appendChild(fileElement);
                        });
                        contextInfo.style.display = 'block';
                    }
                    currentResponseId = data.response_id; // Armazena o ID da resposta
                    currentUserId = data.user_id; // Armazena o ID do usu√°rio
                    feedbackSection.style.display = 'block'; // Mostra a se√ß√£o de feedback
                } else {
                    iaResponseDiv.innerHTML = `<p class="text-danger"><strong>Erro:</strong> ${data.error}</p>`;
                }
            } catch (error) {
                iaResponseDiv.innerHTML = `<p class="text-danger"><strong>Erro de conex√£o.</strong> Verifique o console do servidor.</p>`;
            } finally {
                spinner.style.display = 'none';
                askButton.disabled = false;
            }
        });

        // NEW: Listeners de eventos para feedback
        feedbackGoodBtn.addEventListener('click', () => {
            submitFeedback(1);
            feedbackCommentArea.style.display = 'none'; // Esconde √°rea de coment√°rio para feedback positivo
            feedbackSection.style.display = 'none'; // Esconde toda a se√ß√£o de feedback ap√≥s feedback positivo
        });

        feedbackBadBtn.addEventListener('click', () => {
            feedbackCommentArea.style.display = 'block'; // Mostra √°rea de coment√°rio para feedback negativo
            submitFeedback(0); // Envia 0 para feedback negativo imediatamente
        });

        submitCommentBtn.addEventListener('click', () => {
            const comment = feedbackCommentInput.value;
            if (lastSubmittedRating !== null) { // Garante que h√° uma classifica√ß√£o anterior para associar o coment√°rio
                submitFeedback(lastSubmittedRating, comment);
            } else {
                feedbackMessageDiv.innerHTML = '<p class="text-danger">Por favor, selecione uma avalia√ß√£o primeiro.</p>';
            }
        });


        async function submitFeedback(rating, comment = null) {
            if (!currentResponseId || !currentUserId) {
                feedbackMessageDiv.innerHTML = '<p class="text-danger">Erro: ID da resposta ou do usu√°rio n√£o dispon√≠vel.</p>';
                return;
            }

            lastSubmittedRating = rating; // Armazena a classifica√ß√£o para uso posterior com coment√°rios

            // Desabilita bot√µes para evitar m√∫ltiplas submiss√µes
            feedbackGoodBtn.disabled = true;
            feedbackBadBtn.disabled = true;
            submitCommentBtn.disabled = true;

            try {
                const response = await fetch('/api/submit_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        response_id: currentResponseId,
                        user_id: currentUserId,
                        rating: rating,
                        comment: comment
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    feedbackMessageDiv.innerHTML = `<p class="text-success">${data.message}</p>`;
                    if (comment !== null) { // Se um coment√°rio foi submetido, esconde a √°rea de coment√°rio
                         feedbackCommentArea.style.display = 'none';
                         feedbackSection.style.display = 'none'; // Esconde toda a se√ß√£o ap√≥s o envio do coment√°rio
                    }
                } else {
                    feedbackMessageDiv.innerHTML = `<p class="text-danger">Erro: ${data.error}</p>`;
                }
            } catch (error) {
                feedbackMessageDiv.innerHTML = `<p class="text-danger">Erro de conex√£o ao enviar feedback.</p>`;
            } finally {
                // Reabilita os bot√µes de feedback se o coment√°rio n√£o foi o feedback final (ex: apenas o rating inicial)
                if (comment === null) {
                    // Os bot√µes s√≥ devem ser reativados se o usu√°rio ainda puder adicionar um coment√°rio ao feedback "ruim"
                    // ou se n√£o houver um feedback completo ainda.
                    // Para simplificar, desativamos totalmente os bot√µes de feedback ap√≥s qualquer envio para evitar confus√£o.
                    // Se√ß√µes de feedback "Good" e "Bad" devem ser desabilitadas para uma dada resposta ap√≥s o primeiro feedback.
                }
            }
        }
    </script>
</body>
</html>