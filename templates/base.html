<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}LuftDocs{% endblock %}</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/icon2.png') }}" type="image/png">
    <link rel="icon" href="{{ url_for('static', filename='assets/icon2.png') }}" sizes="32x32" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-theme-style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.css"/>
    <style>
     /* --- VARI√ÅVEIS GLOBAIS --- */
     :root {
         --font-size-base: 1rem; /* Vari√°vel √∫nica para tamanho da fonte */
         
         /* Tema Claro (Padr√£o) */
         --bg-color: #f9f9fb;
         --text-color: #212529;
         --surface-bg: #ffffff; /* Navbar, Footer, Cards */
         --surface-color: #23263b;
         --accent-color: #1a237e;
         --border-color: #dee2e6;
         --shadow-color: #0000000d;
        --lia-bg-color-light: #f0f2f5;
        --lia-surface-color-light: rgba(255, 255, 255, 0.5);
        --lia-glow-color-light: #0d6efd;

        --lia-bg-color-dark: #0A0A10;
        --lia-surface-color-dark: rgba(25, 28, 41, 0.5);
        --lia-glow-color-dark: #339dff;

        --lia-grad-1: #0077ff;
        --lia-grad-2: #00eaff;
        --lia-grad-3: #9400d3;
     }

     /* --- TEMA ESCURO --- */
     body.theme-dark {
         --bg-color: #1e1e1e;
         --text-color: #e7eaf1;
         --surface-bg: #2b2b3a;
         --surface-color: #f8f9fa;
         --accent-color: #f5f5f5;
         --border-color: #444444;
         --shadow-color: #00000026;
     }

     /* --- ESTILOS BASE --- */
     body {
         background-color: var(--bg-color);
         color: var(--text-color);
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         font-size: var(--font-size-base);
         margin: 0;
         transition: background-color 0.3s, color 0.3s, font-size 0.3s;
     }
     
     /* --- LAYOUT --- */
     .navbar, .footer-LuftDocs {
         background-color: var(--surface-bg);
         color: var(--surface-color);
         padding: 1rem clamp(1rem, 4vw, 6rem); /* Padding responsivo com clamp() */
         box-shadow: 0 2px 12px var(--shadow-color);
         transition: background-color 0.3s, color 0.3s;
     }

     .navbar {
         display: flex;
         justify-content: space-between;
         align-items: center;
         flex-wrap: wrap; /* Permite que os itens quebrem a linha em telas pequenas */
         gap: 1rem;
     }
     
     .main {
         padding: 2rem clamp(1rem, 4vw, 6rem); /* Padding responsivo */
         max-width: 1200px;
         margin: 0 auto;
     }

     .footer-LuftDocs {
         margin-top: 0rem;
         padding-top: 0rem;
         padding-bottom: 1.5rem;
         text-align: center;
         box-shadow: 0 -2px 10px var(--shadow-color);
     }
     
     /* --- COMPONENTES --- */
     .logo-wiki {
         color: var(--surface-color);
         font-size: 1.35rem;
         font-weight: 700;
         text-decoration: none;
         transition: color 0.15s;
     }
     .logo-wiki:hover { color: #0d6efd; }

     .modulo-conteudo img, .modulo-conteudo video {
         max-width: 440px;
         width: 100%;
         height: auto;
         display: block;
         margin: 1.5rem auto;
         border-radius: 12px;
         box-shadow: 0 2px 10px var(--shadow-color);
         transition: box-shadow 0.2s, filter 0.2s;
         cursor: pointer;
     }
     .modulo-conteudo img:hover, .modulo-conteudo video:hover {
         box-shadow: 0 6px 24px #00b4d820, 0 2px 12px #0000001a;
         filter: brightness(1.04);
     }
     
     /* --- OVERRIDES TEMA ESCURO --- */
     body.theme-dark .card,
     body.theme-dark .modal-content,
     body.theme-dark .dropdown-menu {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }

     body.theme-dark .text-body,
     body.theme-dark .dropdown-item,
     body.theme-dark .form-check-label {
         color: var(--text-color) !important;
     }
     
     body.theme-dark .text-primary { color: var(--accent-color) !important; }
     body.theme-dark .text-dark { color: var(--surface-color) !important; }

     body.theme-dark .btn-outline-dark {
         color: var(--surface-color);
         border-color: var(--surface-color);
     }
     body.theme-dark .btn-outline-dark:hover {
         color: var(--surface-bg);
         background-color: var(--surface-color);
     }
     
     body.theme-dark .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

     body.theme-dark .nav-tabs .nav-link {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }
     body.theme-dark .nav-tabs .nav-link.active { background-color: #3a3a4a; }

     body.theme-dark .form-select,
     body.theme-dark .form-check-input {
         background-color: #1e1e1e;
         color: var(--text-color);
         border-color: var(--border-color);
     }


    /* ================================================================= */
    /* === LIA AI - REDESIGN FUTURISTA ================================= */
    /* ================================================================= */

    /* --- Vari√°veis de Cor para o Tema da IA --- */
    :root {
        --lia-bg-light: #f0f2f5;
        --lia-surface-light: rgba(255, 255, 255, 0.5);
        --lia-glow-light: #0d6efd;
        --lia-border-light: rgba(255, 255, 255, 0.2);

        --lia-bg-dark: #0A0A10;
        --lia-surface-dark: rgba(25, 28, 41, 0.5);
        --lia-glow-dark: #339dff;
        --lia-border-dark: rgba(50, 50, 80, 0.3);
    }

    /* --- Bot√£o Flutuante --- */
    .floating-lia-btn {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 1050;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0d6efd, #0558ca);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        border: none;
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        animation: lia-pulse 2.5s infinite;
    }
    .floating-lia-btn:hover {
        transform: scale(1.15) rotate(15deg);
        box-shadow: 0 12px 40px rgba(13, 110, 253, 0.5);
        animation: none;
    }

    /* --- Estrutura do Modal --- */
    #liaModal .modal-dialog {
        max-width: 900px;
    }
    #liaModal .modal-content {
        background: transparent;
        border: none;
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
    }

    /* Anima√ß√£o de entrada do Modal */
    .modal.fade .modal-dialog {
        transform: scale(0.95) translateY(20px);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s ease;
    }
    .modal.show .modal-dialog {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    /* --- Corpo do Modal --- */
    #liaModal .modal-body {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 850px;
        padding: 0;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        background-color: var(--lia-bg-light);
        border: 1px solid var(--lia-border-light);
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    body.theme-dark #liaModal .modal-body {
        background-color: var(--lia-bg-dark);
        border: 1px solid var(--lia-border-dark);
    }

    /* Padr√£o de grade animado no fundo */
    #liaModal .modal-body::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: 
            linear-gradient(rgba(13, 110, 253, 0.05) 1px, transparent 1px),
            linear-gradient(to right, rgba(13, 110, 253, 0.05) 1px, transparent 1px);
        background-size: 30px 30px;
        animation: lia-grid-scroll 10s linear infinite;
        z-index: 1;
    }
    body.theme-dark #liaModal .modal-body::before {
        background-image: 
            linear-gradient(rgba(51, 157, 255, 0.1) 1px, transparent 1px),
            linear-gradient(to right, rgba(51, 157, 255, 0.1) 1px, transparent 1px);
    }

    /* --- √Årea de Respostas do Chat --- */
    #liaResponseContainer {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    #liaResponseContainer::-webkit-scrollbar { width: 6px; }
    #liaResponseContainer::-webkit-scrollbar-track { background: transparent; }
    #liaResponseContainer::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 6px; }

    /* --- Bal√µes de Mensagem --- */
    #liaResponseContainer .lia-message {
        padding: 0.8rem 1.2rem;
        border-radius: 12px;
        max-width: 85%;
        width: fit-content;
        line-height: 1.6;
        animation: lia-fade-in-up 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        background: var(--lia-surface-light);
        border: 1px solid var(--lia-border-light);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    body.theme-dark #liaResponseContainer .lia-message {
        background: var(--lia-surface-dark);
        border: 1px solid var(--lia-border-dark);
    }
    #liaResponseContainer .user-message {
        margin-left: auto; /* Alinha √† direita */
        background: var(--lia-glow-light);
        color: white;
    }
    body.theme-dark #liaResponseContainer .user-message {
        background: var(--lia-glow-dark);
        color: #0A0A10;
    }

    /* --- √Årea de Input --- */
    .lia-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--lia-border-light);
        background: var(--lia-surface-light);
        z-index: 3;
        position: relative;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    body.theme-dark .lia-input-area {
        background: var(--lia-surface-dark);
        border-top: 1px solid var(--lia-border-dark);
    }

    .lia-input-area .input-group {
        border-radius: 12px;
        background: var(--lia-bg-light);
        padding: 0.25rem;
        border: 1px solid var(--border-color);
        transition: box-shadow 0.3s, border-color 0.3s;
    }
    body.theme-dark .lia-input-area .input-group {
        background: var(--lia-bg-dark);
    }
    .lia-input-area .input-group:focus-within {
        border-color: var(--lia-glow-light);
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    body.theme-dark .lia-input-area .input-group:focus-within {
        border-color: var(--lia-glow-dark);
        box-shadow: 0 0 0 3px rgba(51, 157, 255, 0.25);
    }

    #iaResponse img {
        border-radius: 0.75rem !important; /* Bordas mais suaves na imagem */
        margin: 1rem 0;
    }

    /* Define um tamanho m√°ximo para as imagens dentro dos bal√µes de mensagem */
    #liaResponseContainer .lia-message img {
        max-width: 450px; /* <<-- Altere este valor como quiser */
        height: auto;
        display: block;
        margin: 1rem auto; /* Centraliza a imagem */
        border-radius: 12px; /* Adiciona bordas arredondadas √† imagem */
    }

    .lia-input-area #liaUserQuestion,
    .lia-input-area #liaUserQuestion:focus {
        background: transparent;
        border: none;
        color: var(--text-color);
        box-shadow: none;
    }
    .lia-input-area #liaAskButton,
    .lia-input-area #liaModulesHelperBtn {
        border-radius: 10px !important;
    }

    /* --- Autocomplete e Contexto --- */
    #liaModulesList {
        background-color: var(--surface-bg);
    }
    .lia-context-area {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
    }

    /* --- Keyframes para Anima√ß√µes --- */
    @keyframes lia-pulse {
        50% { transform: scale(1.05); }
    }
    @keyframes lia-grid-scroll {
        from { background-position: 0 0; }
        to { background-position: 30px 30px; }
    }
    @keyframes lia-fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .lia-proactive {
        /* Ativa a anima√ß√£o de pulso e brilho */
        animation: lia-proactive-pulse 2s infinite;
    }

    @keyframes lia-proactive-pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 10px 40px rgba(13, 110, 253, 0.6);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
        }
    }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index.index', token=request.args.get('token')) }}" class="logo-wiki d-flex align-items-center">
            <img src="{{ url_for('static', filename='assets/icon2.png') }}" alt="LuftDocs Logo" width="50" height="50" class="me-2">
            <span>LuftDocs</span>
        </a>
        <div class="d-flex align-items-center">
            
            <a href="{{ url_for('search.perform_search', token=request.args.get('token')) }}"  class="btn btn-outline-dark fw-bold me-3">
                <i class="bi bi-search"></i>
                <span class="d-none d-sm-inline">Buscar</span>
            </a>
            
            <div class="dropdown">
                <a class="btn btn-link text-dark p-0 dropdown-toggle text-decoration-none" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle" style="font-size: 1.8rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalMinhaConta"><i class="bi bi-person-badge me-2"></i>Minha Conta</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalConfiguracoes"><i class="bi bi-gear me-2"></i>Configura√ß√µes</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('index.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main" id="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <footer class="footer-LuftDocs">
        LuftDocs &copy; 2025 ‚Äî Feito para facilitar seu dia a dia.
    </footer>

    <div class="modal fade" id="modalMinhaConta" tabindex="-1" aria-labelledby="modalMinhaContaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMinhaContaLabel"><i class="bi bi-person-badge me-2"></i>Informa√ß√µes da Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-lg">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Usu√°rio:</strong> {{ session['user_name'] }}</li>
                        <li class="list-group-item"><strong>Email:</strong> {{ session['email'] }}</li>
                        <li class="list-group-item"><strong>Grupo:</strong> {{ session['user_group']['acronym'] }}</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfiguracoes" tabindex="-1" aria-labelledby="modalConfigLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="modalConfigLabel"><i class="bi bi-gear-fill me-2"></i>Configura√ß√µes</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#visuais">Visuais</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link dev-feature" data-bs-toggle="tab" data-bs-target="#operacoes">Opera√ß√µes</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="visuais">
                            <form id="formVisuais" class="row g-4">
                                <div class="col-md-6 col-lg-4"><label for="selectTema" class="form-label">Tema</label><select id="selectTema" class="form-select"><option value="light">Claro</option><option value="dark">Escuro</option><option value="auto">Autom√°tico</option></select></div>
                                <div class="col-md-6 col-lg-4"><label for="fontSize" class="form-label">Tamanho da Fonte</label><select id="fontSize" class="form-select"><option value="0.85rem">Pequena</option><option value="1rem">M√©dia</option><option value="1.15rem">Grande</option><option value="1.3rem">Extra Grande</option></select></div>
                                <div class="col-md-6 col-lg-4"><label for="selectAnimacao" class="form-label">Anima√ß√£o de Fundo</label><select id="selectAnimacao" class="form-select"><option value="colisao">Nova</option><option value="original">Cl√°ssica</option></select></div>
                                <div class="col-md-6"><label for="rangeQuantidade" class="form-label">(BETA) √çcones: <span id="labelQuantidade">50</span></label><input type="range" class="form-range" min="10" max="150" step="5" id="rangeQuantidade"></div>
                                <div class="col-md-6"><label for="rangeVelocidade" class="form-label">(BETA) Velocidade: <span id="labelVelocidade">1.0x</span></label><input type="range" class="form-range" min="0.2" max="3.0" step="0.1" id="rangeVelocidade"></div>
                                <div class="col-12 mt-4"><div class="form-check form-switch"><input class="form-check-input dev-feature" type="checkbox" id="switchCompactMode"><label class="form-check-label" for="switchCompactMode">Modo Compacto</label></div></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="operacoes">
                            <p class="text-center text-muted">Esta se√ß√£o est√° em desenvolvimento.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary" id="btnSalvarConfigs"><i class="bi bi-save-fill me-2"></i>Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalDev" tabindex="-1" aria-labelledby="modalDevLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body">
                    <i class="bi bi-tools fs-1 text-warning mb-3"></i>
                    <h5 id="modalDevLabel">Em Desenvolvimento</h5>
                    <p class="mb-4">Este recurso estar√° dispon√≠vel em breve!</p>
                    <button class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="configToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">Configura√ß√µes salvas com sucesso! ‚úÖ</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>


    <div class="modal fade" id="liaModal" tabindex="-1" aria-labelledby="liaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="position: absolute; top: 20px; right: 20px; z-index: 4;"></button>
                
                <div class="modal-body">
                    <div id="liaResponseContainer">
                        </div>

                    <div class="lia-input-area">
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col"><h5 class="modal-title" id="liaModalLabel">ü§ñ Fale com a Lia</h5></div>
                            <div class="col-auto">
                                <label for="liaModelSelector" class="form-label small mb-0 visually-hidden">Modelo:</label>
                                <select class="form-select form-select-sm" id="liaModelSelector">
                                    <option value="groq-70b" selected>Groq (Llama 3 70b)</option>
                                    <option value="groq-8b">Groq (Llama 3 8b)</option>
                                    <option value="gemini">Gemini (1.5 Flash)</option>
                                    <option value="kimi">Moonshot Kimi (Instruct)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-wrapper" style="position: relative;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="liaUserQuestion" placeholder="Pergunte ou use @ para focar em um m√≥dulo...">
                                
                                <button class="btn btn-outline-secondary" type="button" id="liaModulesHelperBtn" title="Mencionar m√≥dulo">
                                    <i class="bi bi-at"></i>
                                </button>
                                
                                <button class="btn btn-primary" id="liaAskButton" type="button">
                                    <span id="liaSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>

                            <div id="liaModulesList" class="list-group" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; z-index: 10; max-height: 160px; overflow-y: auto; margin-bottom: 0.5rem; box-shadow: 0 -4px 15px rgba(0,0,0,0.1);">
                                </div>
                        </div>

                        {% if can_view_tecnico %}
                            <div id="context-info-wrapper" class="mt-2" style="display: none;">
                                </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if can_view_tools_in_development %}
    <div class="floating-lia-btn" 
        data-bs-toggle="modal" 
        data-bs-target="#liaModal" 
        title="Perguntar √† Lia"
        data-proactive-module-name="{{ proactive_module_name or '' }}"
        data-proactive-module-id="{{ proactive_module_id or '' }}">
        <i class="bi bi-stars"></i>
    </div>
    {% endif %}
    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
    // Script principal unificado para melhor organiza√ß√£o e performance.
    document.addEventListener('DOMContentLoaded', () => {
        // --- INST√ÇNCIAS E ELEMENTOS ---
        const devModal = new bootstrap.Modal(document.getElementById('modalDev'));
        const configToast = bootstrap.Toast.getOrCreateInstance(document.getElementById('configToast'));
        const highlightStyle = document.getElementById('highlight-theme-style');
        const body = document.body;

        const ui = {
            selectTema: document.getElementById('selectTema'),
            fontSize: document.getElementById('fontSize'),
            switchCompactMode: document.getElementById('switchCompactMode'),
            selectAnimacao: document.getElementById('selectAnimacao'),
            rangeQuantidade: document.getElementById('rangeQuantidade'),
            labelQuantidade: document.getElementById('labelQuantidade'),
            rangeVelocidade: document.getElementById('rangeVelocidade'),
            labelVelocidade: document.getElementById('labelVelocidade'),
            btnSalvarConfigs: document.getElementById('btnSalvarConfigs')
        };
        
        // --- FUN√á√ïES DE CONFIGURA√á√ÉO ---
        const applyTheme = (theme) => {
            const isDark = (theme === 'dark') || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            body.classList.toggle('theme-dark', isDark);
            highlightStyle.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github${isDark ? '-dark' : ''}.min.css`;
        };

        const applyFontSize = (size) => {
            body.style.setProperty('--font-size-base', size);
        };

        const applyBgAnimation = (mode) => {
            if (typeof window.mudarAnimacao === 'function') {
                window.mudarAnimacao(mode);
            }
        };

        // --- CARREGAMENTO INICIAL DAS CONFIGS ---
        const loadSettings = () => {
            const settings = {
                theme: localStorage.getItem('ld_theme') || 'light',
                fontSize: localStorage.getItem('ld_fontSize') || '1rem',
                bgAnimation: localStorage.getItem('ld_bgAnimation') || 'colisao',
                bgQuantity: localStorage.getItem('ld_bg_quantity') || '50',
                bgSpeed: localStorage.getItem('ld_bg_speed') || '1.0'
            };
            
            applyTheme(settings.theme);
            applyFontSize(settings.fontSize);
            applyBgAnimation(settings.bgAnimation);

            // Preenche os inputs do modal
            if (ui.selectTema) { // Verifica se os elementos existem antes de us√°-los
                ui.selectTema.value = settings.theme;
                ui.fontSize.value = settings.fontSize;
                ui.selectAnimacao.value = settings.bgAnimation;
                ui.rangeQuantidade.value = settings.bgQuantity;
                ui.labelQuantidade.textContent = settings.bgQuantity;
                ui.rangeVelocidade.value = settings.bgSpeed;
                ui.labelVelocidade.textContent = `${settings.bgSpeed}x`;
            }
            
            // Ativa highlight.js e Viewer.js
            hljs.highlightAll();
            const viewerEl = document.getElementById('main-content');
            if (viewerEl) {
                new Viewer(viewerEl, {
                    filter(image) { return image.parentElement.classList.contains('modulo-conteudo'); }, // Visualizar apenas imagens no conte√∫do
                    toolbar: true, navbar: false, title: false, movable: true, zoomable: true,
                    rotatable: false, scalable: false, transition: true, fullscreen: true,
                });
            }
        };
        
        // --- EVENT LISTENERS ---
        if(ui.btnSalvarConfigs) {
            ui.btnSalvarConfigs.addEventListener('click', () => {
                const newSettings = { theme: ui.selectTema.value, fontSize: ui.fontSize.value, bgAnimation: ui.selectAnimacao.value, bgQuantity: ui.rangeQuantidade.value, bgSpeed: ui.rangeVelocidade.value };
                Object.entries(newSettings).forEach(([key, value]) => { localStorage.setItem(`ld_${key}`, value); });
                localStorage.setItem('ld_bg_quantity', newSettings.bgQuantity);
                localStorage.setItem('ld_bg_speed', newSettings.bgSpeed);
                applyTheme(newSettings.theme);
                applyFontSize(newSettings.fontSize);
                applyBgAnimation(newSettings.bgAnimation);
                configToast.show();
                bootstrap.Modal.getInstance(document.getElementById('modalConfiguracoes')).hide();
            });

            // Sliders de range
            ui.rangeQuantidade.addEventListener('input', e => ui.labelQuantidade.textContent = e.target.value);
            ui.rangeVelocidade.addEventListener('input', e => ui.labelVelocidade.textContent = `${e.target.value}x`);
        }

        // Gatilho para features em desenvolvimento
        document.querySelectorAll('.dev-feature').forEach(el => {
            const eventType = el.type === 'checkbox' ? 'change' : 'click';
            el.addEventListener(eventType, (e) => {
                if ( (el.type === 'checkbox' && e.target.checked) || (el.type !== 'checkbox') ) {
                    e.preventDefault();
                    e.stopPropagation();
                    devModal.show();
                    if (el.type === 'checkbox') e.target.checked = false; // Desfaz a a√ß√£o
                    if(el.hasAttribute('data-bs-toggle')) {
                        const previousTab = document.querySelector('.nav-tabs .nav-link.active');
                        if(previousTab) bootstrap.Tab.getOrCreateInstance(previousTab).show();
                    }
                }
            });
        });

        // --- INICIALIZA√á√ÉO ---
        loadSettings();
    });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const liaModal = document.getElementById('liaModal');
        if (!liaModal) return; 

        // --- SELETORES DE ELEMENTOS ---
        const liaFloatingBtn = document.querySelector('.floating-lia-btn'); // Adicionado seletor para o bot√£o
        const askButton = document.getElementById('liaAskButton');
        const userQuestionInput = document.getElementById('liaUserQuestion');
        const modelSelector = document.getElementById('liaModelSelector');
        const responseContainer = document.getElementById('liaResponseContainer');
        const spinner = document.getElementById('liaSpinner');
        const sendIcon = askButton.querySelector('.bi-send-fill');
        const modulesHelperBtn = document.getElementById('liaModulesHelperBtn');
        const modulesListDiv = document.getElementById('liaModulesList');
        const contextInfoWrapper = document.getElementById('context-info-wrapper');

        // ==========================================================
        // === L√ìGICA DO ASSISTENTE PROATIVO ==========================
        // ==========================================================
        // Lemos os dois atributos do bot√£o flutuante
        const proactiveModuleName = liaFloatingBtn.dataset.proactiveModuleName;
        const proactiveModuleId = liaFloatingBtn.dataset.proactiveModuleId;

        if (proactiveModuleName && proactiveModuleId) {
            // Se os atributos existirem, ativa a anima√ß√£o de pulso no bot√£o.
            liaFloatingBtn.classList.add('lia-proactive');
        }
        // ========================================================
        // === FIM DA L√ìGICA DO ASSISTENTE PROATIVO =================
        // ========================================================

        // --- L√ìGICA DE AUTOCOMPLETE DE M√ìDULOS ---
        let modulesCache = [];
        let isListVisible = false;

        const fetchModules = async () => {
            if (modulesCache.length > 0) return modulesCache;
            try {
                const response = await fetch("{{ url_for('ia_bp.get_modules_list') }}");
                if (!response.ok) return [];
                const data = await response.json();
                modulesCache = data.modules;
                return modulesCache;
            } catch (error) {
                console.error("Erro ao buscar lista de m√≥dulos:", error);
                return [];
            }
        };

        const showModulesList = (filter = '') => {
            fetchModules().then(modules => {
                const filteredModules = modules.filter(m => m.toLowerCase().includes(filter.toLowerCase()));
                if (filteredModules.length === 0) {
                    hideModulesList();
                    return;
                }
                
                modulesListDiv.innerHTML = '';
                filteredModules.forEach(module => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action py-2 px-3';
                    item.textContent = `@${module}`;
                    item.onclick = (e) => {
                        e.preventDefault();
                        const currentText = userQuestionInput.value;
                        const atIndex = currentText.lastIndexOf('@');
                        userQuestionInput.value = currentText.substring(0, atIndex) + `@${module} `;
                        hideModulesList();
                        userQuestionInput.focus();
                    };
                    modulesListDiv.appendChild(item);
                });
                modulesListDiv.style.display = 'block';
                isListVisible = true;
            });
        };

        const hideModulesList = () => {
            modulesListDiv.style.display = 'none';
            isListVisible = false;
        };
        
        // --- L√ìGICA PRINCIPAL DO CHAT ---
        const removeWelcomeMessage = () => {
            const welcome = responseContainer.querySelector('.alert-welcome');
            if (welcome) welcome.remove();
        };

        const handleAsk = async () => {
            const userQuestion = userQuestionInput.value;
            if (!userQuestion.trim()) return;

            removeWelcomeMessage();
            if (contextInfoWrapper) contextInfoWrapper.style.display = 'none';
            
            spinner.style.display = 'inline-block';
            sendIcon.style.display = 'none';
            askButton.disabled = true;
            userQuestionInput.disabled = true;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'lia-message user-message';
            userMessageDiv.textContent = userQuestion;
            responseContainer.appendChild(userMessageDiv);
            responseContainer.scrollTop = responseContainer.scrollHeight;

            userQuestionInput.value = ''; 

            try {
                const response = await fetch("{{ url_for('ia_bp.ask_llm_api') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_question: userQuestion,
                        selected_model: modelSelector.value 
                    }),
                });

                const data = await response.json();
                const answerDiv = document.createElement('div');
                answerDiv.className = 'lia-message';
                
                if (response.ok) {
                    answerDiv.innerHTML = marked.parse(data.answer);

                    if (contextInfoWrapper && data.context_files && data.context_files.length > 0) {
                        const collapseId = `liaContextCollapse-${Date.now()}`;
                        const filesList = data.context_files.map(file => `<li class="list-group-item">${file}</li>`).join('');
                        contextInfoWrapper.innerHTML = `
                            <a class="btn-context" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false">
                                Fontes utilizadas <i class="bi bi-chevron-down ms-1"></i>
                            </a>
                            <div class="collapse" id="${collapseId}">
                                <ul class="list-group list-group-flush mt-2">${filesList}</ul>
                            </div>
                        `;
                        contextInfoWrapper.style.display = 'block';
                    }
                } else {
                    answerDiv.classList.add('bg-danger', 'text-white');
                    answerDiv.innerHTML = `<strong>Erro:</strong> ${data.error}`;
                }
                responseContainer.appendChild(answerDiv);

            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'lia-message bg-danger text-white';
                errorDiv.innerHTML = '<strong>Erro de conex√£o.</strong> Verifique o console do servidor.';
                responseContainer.appendChild(errorDiv);
            } finally {
                spinner.style.display = 'none';
                sendIcon.style.display = 'inline-block';
                askButton.disabled = false;
                userQuestionInput.disabled = false;
                userQuestionInput.focus();
                responseContainer.scrollTop = responseContainer.scrollHeight;
            }
        };

        // --- EVENT LISTENERS ---
        userQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleAsk();
            }
        });

        askButton.addEventListener('click', handleAsk);

        modulesHelperBtn.addEventListener('click', () => {
            if (isListVisible) hideModulesList();
            else {
                const val = userQuestionInput.value;
                userQuestionInput.value += (val.length > 0 && !val.endsWith(' ')) ? ' @' : '@';
                userQuestionInput.focus();
                showModulesList();
            }
        });

        userQuestionInput.addEventListener('input', () => {
            const text = userQuestionInput.value;
            const atIndex = text.lastIndexOf('@');
            if (atIndex !== -1 && !text.includes(' ', atIndex)) {
                showModulesList(text.substring(atIndex + 1));
            } else {
                hideModulesList();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!modulesListDiv.contains(e.target) && e.target !== userQuestionInput && e.target !== modulesHelperBtn && !modulesHelperBtn.contains(e.target)) {
                hideModulesList();
            }
        });

        // ATUALIZADO: L√≥gica de abertura do Modal
        liaModal.addEventListener('shown.bs.modal', () => {
            userQuestionInput.focus();
            
            // Exibe a mensagem de boas-vindas apenas se o chat estiver vazio.
            if (responseContainer.children.length === 0) {
                let welcomeMessage = '';
                // Usa o NOME do m√≥dulo para a mensagem
                if (proactiveModuleName) {
                    const formattedModuleName = proactiveModuleName.replace(/-/g, ' ');
                    welcomeMessage = `<div class="alert alert-light my-2 alert-welcome">Ol√°! üëã Vi que voc√™ est√° na p√°gina de <strong>${formattedModuleName}</strong>. Posso ajudar com alguma d√∫vida sobre este processo?</div>`;
                } else {
                    welcomeMessage = '<div class="alert alert-light my-2 alert-welcome">Ol√°! üëã Sou a Lia, sua assistente de conhecimento.</div>';
                }
                responseContainer.innerHTML = welcomeMessage;
            }

            // Pr√©-preenche o input com o @ID do m√≥dulo
            if (proactiveModuleId) {
                if (!userQuestionInput.value.includes(`@${proactiveModuleId}`)) {
                    userQuestionInput.value = `@${proactiveModuleId} `;
                }
            }
        });
    });
    </script>
        {% endblock %}
</body>
</html>