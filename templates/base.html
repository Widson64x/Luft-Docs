<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}LuftDocs{% endblock %}</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/icon2.png') }}" type="image/png">
    <link rel="icon" href="{{ url_for('static', filename='assets/icon2.png') }}" sizes="32x32" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-theme-style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.css"/>
    <style>
     /* --- VARI√ÅVEIS GLOBAIS --- */
     :root {
         --font-size-base: 1rem; /* Vari√°vel √∫nica para tamanho da fonte */
         
         /* Tema Claro (Padr√£o) */
         --bg-color: #f9f9fb;
         --text-color: #212529;
         --surface-bg: #ffffff; /* Navbar, Footer, Cards */
         --surface-color: #23263b;
         --accent-color: #1a237e;
         --border-color: #dee2e6;
         --shadow-color: #0000000d;
        --lia-bg-color-light: #f0f2f5;
        --lia-surface-color-light: rgba(255, 255, 255, 0.5);
        --lia-glow-color-light: #0d6efd;

        --lia-bg-color-dark: #0A0A10;
        --lia-surface-color-dark: rgba(25, 28, 41, 0.5);
        --lia-glow-color-dark: #339dff;

        --lia-grad-1: #0077ff;
        --lia-grad-2: #00eaff;
        --lia-grad-3: #9400d3;
     }

     /* --- TEMA ESCURO --- */
     body.theme-dark {
         --bg-color: #1e1e1e;
         --text-color: #e7eaf1;
         --surface-bg: #2b2b3a;
         --surface-color: #f8f9fa;
         --accent-color: #f5f5f5;
         --border-color: #444444;
         --shadow-color: #00000026;
     }

     /* --- ESTILOS BASE --- */
     body {
         background-color: var(--bg-color);
         color: var(--text-color);
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         font-size: var(--font-size-base);
         margin: 0;
         transition: background-color 0.3s, color 0.3s, font-size 0.3s;
     }
     
     /* --- LAYOUT --- */
     .navbar, .footer-LuftDocs {
         background-color: var(--surface-bg);
         color: var(--surface-color);
         padding: 1rem clamp(1rem, 4vw, 6rem); /* Padding responsivo com clamp() */
         box-shadow: 0 2px 12px var(--shadow-color);
         transition: background-color 0.3s, color 0.3s;
     }

     .navbar {
         display: flex;
         justify-content: space-between;
         align-items: center;
         flex-wrap: wrap; /* Permite que os itens quebrem a linha em telas pequenas */
         gap: 1rem;
     }
     
     .main {
         padding: 2rem clamp(1rem, 4vw, 6rem); /* Padding responsivo */
         max-width: 1200px;
         margin: 0 auto;
     }

     .footer-LuftDocs {
         margin-top: 0rem;
         padding-top: 0rem;
         padding-bottom: 1.5rem;
         text-align: center;
         box-shadow: 0 -2px 10px var(--shadow-color);
     }
     
     /* --- COMPONENTES --- */
     .logo-wiki {
         color: var(--surface-color);
         font-size: 1.35rem;
         font-weight: 700;
         text-decoration: none;
         transition: color 0.15s;
     }
     .logo-wiki:hover { color: #0d6efd; }

     .modulo-conteudo img, .modulo-conteudo video {
         max-width: 440px;
         width: 100%;
         height: auto;
         display: block;
         margin: 1.5rem auto;
         border-radius: 12px;
         box-shadow: 0 2px 10px var(--shadow-color);
         transition: box-shadow 0.2s, filter 0.2s;
         cursor: pointer;
     }
     .modulo-conteudo img:hover, .modulo-conteudo video:hover {
         box-shadow: 0 6px 24px #00b4d820, 0 2px 12px #0000001a;
         filter: brightness(1.04);
     }
     
     /* --- OVERRIDES TEMA ESCURO --- */
     body.theme-dark .card,
     body.theme-dark .modal-content,
     body.theme-dark .dropdown-menu {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }

     body.theme-dark .text-body,
     body.theme-dark .dropdown-item,
     body.theme-dark .form-check-label {
         color: var(--text-color) !important;
     }
     
     body.theme-dark .text-primary { color: var(--accent-color) !important; }
     body.theme-dark .text-dark { color: var(--surface-color) !important; }

     body.theme-dark .btn-outline-dark {
         color: var(--surface-color);
         border-color: var(--surface-color);
     }
     body.theme-dark .btn-outline-dark:hover {
         color: var(--surface-bg);
         background-color: var(--surface-color);
     }
     
     body.theme-dark .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

     body.theme-dark .nav-tabs .nav-link {
         background-color: var(--surface-bg);
         color: var(--text-color);
         border-color: var(--border-color);
     }
     body.theme-dark .nav-tabs .nav-link.active { background-color: #3a3a4a; }

     body.theme-dark .form-select,
     body.theme-dark .form-check-input {
         background-color: #1e1e1e;
         color: var(--text-color);
         border-color: var(--border-color);
     }


    /* ================================================================= */
    /* === LIA AI - REDESIGN FUTURISTA ================================= */
    /* ================================================================= */

    /* --- Vari√°veis de Cor para o Tema da IA --- */
    :root {
        --lia-bg-light: #f0f2f5; /* Fundo geral claro */
        --lia-surface-light: rgba(255, 255, 255, 0.5); /* Superf√≠cie (bal√µes, input) clara e transl√∫cida */
        --lia-glow-light: #0d6efd; /* Cor de destaque/brilho clara (azul) */
        --lia-border-light: rgba(255, 255, 255, 0.2); /* Cor de borda sutil clara */

        /* Cores para o tema escuro */
        --lia-bg-dark: #0A0A10; /* Fundo geral escuro */
        --lia-surface-dark: rgba(25, 28, 41, 0.5); /* Superf√≠cie escura e transl√∫cida */
        --lia-glow-dark: #339dff; /* Cor de destaque/brilho escura (azul claro) */
        --lia-border-dark: rgba(50, 50, 80, 0.3); /* Cor de borda sutil escura */

        /* Vari√°veis globais para integra√ß√£o com o tema principal do site */
        --text-color: #212529; /* Cor padr√£o do texto no tema claro */
        --border-color: #dee2e6; /* Cor padr√£o da borda no tema claro */
        --surface-bg: #ffffff; /* Cor padr√£o da superf√≠cie no tema claro */
    }

    /* Adapta√ß√£o das vari√°veis globais para o tema escuro do site */
    body.theme-dark {
        --text-color: #f8f9fa; /* Cor do texto no tema escuro */
        --border-color: #495057; /* Cor da borda no tema escuro */
        --surface-bg: #212529; /* Cor da superf√≠cie no tema escuro */
    }

    /* --- Bot√£o Flutuante (LIA) --- */
    .floating-lia-btn {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 1050; /* Garante que esteja acima de outros elementos */
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0d6efd, #0558ca); /* Gradiente de azul */
        color: white;
        border-radius: 50%; /* Bot√£o redondo */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        border: none;
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4); /* Sombra vibrante */
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Transi√ß√£o suave e bouncy */
        animation: lia-pulse 2.5s infinite; /* Anima√ß√£o de pulso padr√£o */
    }
    .floating-lia-btn:hover {
        transform: scale(1.15) rotate(15deg); /* Efeito de escala e rota√ß√£o ao hover */
        box-shadow: 0 12px 40px rgba(13, 110, 253, 0.5);
        animation: none; /* Remove a anima√ß√£o de pulso ao hover */
    }

    /* --- Estrutura do Modal --- */
    #liaModal .modal-dialog {
        max-width: 900px;
    }
    #liaModal .modal-content {
        background: transparent; /* Fundo transparente para o efeito de vidro */
        border: none;
        backdrop-filter: blur(16px) saturate(180%); /* Efeito de vidro principal */
        -webkit-backdrop-filter: blur(16px) saturate(180%);
    }

    /* Anima√ß√£o de entrada do Modal */
    .modal.fade .modal-dialog {
        transform: scale(0.95) translateY(20px);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s ease;
    }
    .modal.show .modal-dialog {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    /* --- Corpo do Modal (√°rea principal) --- */
    #liaModal .modal-body {
        display: flex;
        flex-direction: column;
        height: 80vh; /* Altura responsiva */
        max-height: 850px; /* Altura m√°xima */
        padding: 0;
        border-radius: 16px;
        overflow: hidden; /* Garante que o grid de fundo n√£o vaze */
        position: relative;
        background-color: var(--lia-bg-light); /* Fundo base */
        border: 1px solid var(--lia-border-light); /* Borda sutil */
        box-shadow: 0 10px 40px rgba(0,0,0,0.2); /* Sombra forte para destaque */
    }
    body.theme-dark #liaModal .modal-body {
        background-color: var(--lia-bg-dark);
        border: 1px solid var(--lia-border-dark);
    }

    /* Padr√£o de grade animado no fundo */
    #liaModal .modal-body::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: 
            linear-gradient(rgba(13, 110, 253, 0.05) 1px, transparent 1px),
            linear-gradient(to right, rgba(13, 110, 253, 0.05) 1px, transparent 1px);
        background-size: 30px 30px; /* Tamanho da c√©lula da grade */
        animation: lia-grid-scroll 10s linear infinite; /* Anima√ß√£o de scroll */
        z-index: 1;
    }
    body.theme-dark #liaModal .modal-body::before {
        background-image: 
            linear-gradient(rgba(51, 157, 255, 0.1) 1px, transparent 1px),
            linear-gradient(to right, rgba(51, 157, 255, 0.1) 1px, transparent 1px);
    }

    /* --- √Årea de Respostas do Chat --- */
    #liaResponseContainer {
        flex-grow: 1; /* Ocupa o espa√ßo dispon√≠vel */
        overflow-y: auto;
        padding: 1.5rem;
        position: relative;
        z-index: 2; /* Acima do grid de fundo */
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Espa√ßamento entre as mensagens */
    }
    /* Estilos da barra de rolagem customizada */
    #liaResponseContainer::-webkit-scrollbar { width: 6px; }
    #liaResponseContainer::-webkit-scrollbar-track { background: transparent; }
    #liaResponseContainer::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 6px; }
    body.theme-dark #liaResponseContainer::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.3); }


    /* --- Bal√µes de Mensagem --- */
    #liaResponseContainer .lia-message {
        padding: 0.8rem 1.2rem;
        border-radius: 12px; /* Bordas mais arredondadas */
        max-width: 85%;
        width: fit-content; /* Ajusta a largura ao conte√∫do */
        line-height: 1.6;
        animation: lia-fade-in-up 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; /* Anima√ß√£o de entrada */
        background: var(--lia-surface-light); /* Cor de fundo com transpar√™ncia */
        border: 1px solid var(--lia-border-light);
        backdrop-filter: blur(10px); /* Efeito de vidro nos bal√µes */
        -webkit-backdrop-filter: blur(10px);
        color: var(--text-color); /* Garante que o texto seja leg√≠vel */
        position: relative; /* Necess√°rio para posicionamento absoluto do feedback */
        padding-bottom: 2rem; /* Aumenta o padding inferior para os bot√µes discretos */
    }
    body.theme-dark #liaResponseContainer .lia-message {
        background: var(--lia-surface-dark);
        border: 1px solid var(--lia-border-dark);
    }
    #liaResponseContainer .user-message {
        margin-left: auto; /* Alinha mensagens do usu√°rio √† direita */
        background: var(--lia-glow-light); /* Cor de destaque para o usu√°rio */
        color: white;
    }
    body.theme-dark #liaResponseContainer .user-message {
        background: var(--lia-glow-dark);
        color: #0A0A10; /* Cor de texto para contraste no tema escuro do user-message */
    }

    /* --- √Årea de Input (pergunta, modelo, bot√µes) --- */
    .lia-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--lia-border-light);
        background: var(--lia-surface-light);
        z-index: 3;
        position: relative;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    body.theme-dark .lia-input-area {
        background: var(--lia-surface-dark);
        border-top: 1px solid var(--lia-border-dark);
    }

    .lia-input-area .input-group {
        border-radius: 12px; /* Bordas arredondadas para o grupo de input */
        background: var(--lia-bg-light);
        padding: 0.25rem;
        border: 1px solid var(--border-color); /* Borda sutil */
        transition: box-shadow 0.3s, border-color 0.3s; /* Transi√ß√£o para o foco */
    }
    body.theme-dark .lia-input-area .input-group {
        background: var(--lia-bg-dark);
    }
    .lia-input-area .input-group:focus-within {
        border-color: var(--lia-glow-light); /* Cor de brilho no foco */
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    body.theme-dark .lia-input-area .input-group:focus-within {
        border-color: var(--lia-glow-dark);
        box-shadow: 0 0 0 3px rgba(51, 157, 255, 0.25);
    }

    #iaResponse img { /* Imagens dentro da resposta da IA */
        border-radius: 0.75rem !important; /* Bordas mais suaves na imagem */
        margin: 1rem 0;
    }

    /* Define um tamanho m√°ximo para as imagens dentro dos bal√µes de mensagem */
    #liaResponseContainer .lia-message img {
        max-width: 450px; /* <<-- Altere este valor como quiser */
        height: auto;
        display: block;
        margin: 1rem auto; /* Centraliza a imagem */
        border-radius: 12px; /* Adiciona bordas arredondadas √† imagem */
    }

    .lia-input-area #liaUserQuestion,
    .lia-input-area #liaUserQuestion:focus {
        background: transparent; /* Fundo transparente */
        border: none; /* Remove a borda padr√£o do input */
        color: var(--text-color);
        box-shadow: none; /* Remove sombra no foco */
    }
    .lia-input-area #liaAskButton,
    .lia-input-area #liaModulesHelperBtn {
        border-radius: 10px !important; /* Bot√µes com bordas arredondadas */
    }

    /* --- Autocomplete e Contexto (ajustes de estilo) --- */
    #liaModulesList {
        background-color: var(--surface-bg);
    }
    .lia-context-area {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
    }
    .btn-context {
        display: block;
        background-color: var(--lia-bg-light); /* Adapta ao tema claro/escuro da Lia */
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        color: var(--lia-glow-light);
        text-decoration: none;
        text-align: center;
        font-size: 0.9rem;
        transition: background-color 0.2s ease-in-out;
    }
    body.theme-dark .btn-context {
        background-color: var(--lia-bg-dark);
        color: var(--lia-glow-dark);
    }
    .btn-context:hover {
        background-color: rgba(13, 110, 253, 0.1); /* Hover suave */
    }
    body.theme-dark .btn-context:hover {
        background-color: rgba(51, 157, 255, 0.1);
    }

    /* --- ESTILOS DE FEEDBACK (DISCRETO E NO CANTO) --- */
    .feedback-section {
        position: absolute; /* Posi√ß√£o absoluta dentro do bal√£o da mensagem */
        bottom: 5px; /* Alinha no canto inferior direito do bal√£o */
        right: 5px;
        z-index: 10; /* Garante que esteja sobre o conte√∫do do bal√£o */
        display: flex; /* Para alinhar os bot√µes */
        align-items: center;
        gap: 8px; /* Espa√ßamento entre os bot√µes de feedback e a mensagem */
        background: none; /* Sem fundo */
        border: none; /* Sem borda */
        padding: 0; /* Sem padding */
        margin: 0; /* Sem margin */
        box-shadow: none; /* Sem sombra */
        text-align: right; /* Alinha conte√∫do √† direita */
        opacity: 0; /* Come√ßa invis√≠vel */
        transform: translateY(10px); /* Come√ßa um pouco abaixo para anima√ß√£o */
        transition: opacity 0.3s ease, transform 0.3s ease; /* Transi√ß√£o suave */
        pointer-events: none; /* Permite clicar atrav√©s quando invis√≠vel */
    }

    /* Mostra a se√ß√£o de feedback ao passar o mouse sobre a mensagem da Lia */
    #liaResponseContainer .lia-message:not(.user-message):hover .feedback-section {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all; /* Habilita cliques quando vis√≠vel */
    }

    .feedback-section small {
        font-size: 0.75rem; /* Fonte menor */
        color: var(--text-color); /* Adapta ao tema */
        display: none; /* Esconde o texto "Esta resposta foi √∫til?" por padr√£o para ser discreto */
    }

    .feedback-buttons {
        display: flex;
        gap: 2px; /* Espa√ßamento muito pequeno entre os bot√µes */
        margin: 0;
    }

    .feedback-buttons button {
        background: transparent; /* Fundo transparente */
        border: none; /* Sem borda */
        padding: 3px 6px; /* Padding m√≠nimo */
        font-size: 0.9rem; /* Tamanho do √≠cone/texto */
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border-radius: 4px; /* Bordas levemente arredondadas */
        color: var(--text-color); /* Cor do √≠cone/texto */
        opacity: 0.7; /* Mais discreto por padr√£o */
    }
    body.theme-dark .feedback-buttons button {
        color: var(--lia-glow-dark); /* √çcones do tema escuro em azul claro */
    }

    .feedback-buttons button:hover {
        background-color: rgba(0, 0, 0, 0.1); /* Fundo sutil ao hover */
        opacity: 1; /* Aumenta a opacidade ao hover */
    }
    body.theme-dark .feedback-buttons button:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .feedback-buttons button.feedback-good-btn:hover {
        color: #28a745; /* Cor verde ao hover */
    }

    .feedback-buttons button.feedback-bad-btn:hover {
        color: #dc3545; /* Cor vermelha ao hover */
    }

    .feedback-comment-area {
        position: absolute; /* Posi√ß√£o absoluta para expandir da base do bal√£o */
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background: var(--lia-bg-light); /* Fundo da √°rea de coment√°rio */
        border-top: 1px solid var(--lia-border-light);
        transform: translateY(100%); /* Come√ßa escondido abaixo */
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        opacity: 0;
        z-index: 11; /* Acima da se√ß√£o de feedback */
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    body.theme-dark .feedback-comment-area {
        background: var(--lia-bg-dark);
        border-top: 1px solid var(--lia-border-dark);
        box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
    }

    /* Mostra a √°rea de coment√°rio */
    .feedback-comment-area[style*="display: block"] {
        transform: translateY(0);
        opacity: 1;
    }

    .feedback-comment-area textarea {
        width: 100%;
        min-height: 50px; /* Altura m√≠nima reduzida */
        border-radius: 0.4rem;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        background-color: var(--surface-bg);
        color: var(--text-color);
        box-shadow: none; /* Remove a sombra interna */
        transition: border-color 0.2s ease-in-out;
    }
    .feedback-comment-area textarea:focus {
        border-color: var(--lia-glow-light); /* Foco em destaque */
        box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.2); /* Sombra de foco mais discreta */
    }
    body.theme-dark .feedback-comment-area textarea:focus {
        border-color: var(--lia-glow-dark);
        box-shadow: 0 0 0 0.15rem rgba(51, 157, 255, 0.2);
    }

    .submit-comment-btn {
        margin-top: 0.8rem; /* Espa√ßamento menor */
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
        border-radius: 0.4rem;
        transition: all 0.2s ease-in-out;
    }

    .feedback-message {
        font-size: 0.8rem; /* Mensagem de feedback menor */
        margin-top: 0.5rem;
        padding: 0.4rem 0.8rem;
        border-radius: 0.2rem;
        font-weight: normal; /* Menos negrito */
        opacity: 0.9;
    }
    /* Cores din√¢micas para sucesso/erro */
    .feedback-message p.text-success {
        color: #157347 !important; /* Cor mais forte para sucesso */
        background-color: #d1e7dd;
        border: 1px solid #a3cfbb;
    }
    .feedback-message p.text-danger {
        color: #bb2d3b !important; /* Cor mais forte para erro */
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
    }
    .feedback-message p.text-info { /* Para a mensagem de "adicione coment√°rio" */
        color: #055160 !important;
        background-color: #dbeaf0;
        border: 1px solid #b6d4fe;
    }

    /* --- Keyframes para Anima√ß√µes --- */
    @keyframes lia-pulse {
        50% { transform: scale(1.05); }
    }
    @keyframes lia-grid-scroll {
        from { background-position: 0 0; }
        to { background-position: 30px 30px; } /* Deslocamento do grid */
    }
    @keyframes lia-fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Anima√ß√£o proativa para o bot√£o flutuante */
    .lia-proactive {
        animation: lia-proactive-pulse 2s infinite;
    }
    @keyframes lia-proactive-pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 10px 40px rgba(13, 110, 253, 0.6);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
        }
    }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index.index', token=request.args.get('token')) }}" class="logo-wiki d-flex align-items-center">
            <img src="{{ url_for('static', filename='assets/icon2.png') }}" alt="LuftDocs Logo" width="50" height="50" class="me-2">
            <span>LuftDocs</span>
        </a>
        <div class="d-flex align-items-center">
            
            <a href="{{ url_for('search.perform_search', token=request.args.get('token')) }}"  class="btn btn-outline-dark fw-bold me-3">
                <i class="bi bi-search"></i>
                <span class="d-none d-sm-inline">Buscar</span>
            </a>
            
            <div class="dropdown">
                <a class="btn btn-link text-dark p-0 dropdown-toggle text-decoration-none" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle" style="font-size: 1.8rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalMinhaConta"><i class="bi bi-person-badge me-2"></i>Minha Conta</a></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalConfiguracoes"><i class="bi bi-gear me-2"></i>Configura√ß√µes</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('index.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main" id="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <footer class="footer-LuftDocs">
        LuftDocs &copy; 2025 ‚Äî Feito para facilitar seu dia a dia.
    </footer>

    <div class="modal fade" id="modalMinhaConta" tabindex="-1" aria-labelledby="modalMinhaContaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMinhaContaLabel"><i class="bi bi-person-badge me-2"></i>Informa√ß√µes da Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-lg">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Usu√°rio:</strong> {{ session['user_name'] }}</li>
                        <li class="list-group-item"><strong>Email:</strong> {{ session['email'] }}</li>
                        <li class="list-group-item"><strong>Grupo:</strong> {{ session['user_group']['acronym'] }}</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfiguracoes" tabindex="-1" aria-labelledby="modalConfigLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="modalConfigLabel"><i class="bi bi-gear-fill me-2"></i>Configura√ß√µes</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#visuais">Visuais</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link dev-feature" data-bs-toggle="tab" data-bs-target="#operacoes">Opera√ß√µes</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="visuais">
                            <form id="formVisuais" class="row g-4">
                                <div class="col-md-6 col-lg-4"><label for="selectTema" class="form-label">Tema</label><select id="selectTema" class="form-select"><option value="light">Claro</option><option value="dark">Escuro</option><option value="auto">Autom√°tico</option></select></div>
                                <div class="col-md-6 col-lg-4"><label for="fontSize" class="form-label">Tamanho da Fonte</label><select id="fontSize" class="form-select"><option value="0.85rem">Pequena</option><option value="1rem">M√©dia</option><option value="1.15rem">Grande</option><option value="1.3rem">Extra Grande</option></select></div>
                                <div class="col-md-6 col-lg-4"><label for="selectAnimacao" class="form-label">Anima√ß√£o de Fundo</label><select id="selectAnimacao" class="form-select"><option value="colisao">Nova</option><option value="original">Cl√°ssica</option></select></div>
                                <div class="col-md-6"><label for="rangeQuantidade" class="form-label">(BETA) √çcones: <span id="labelQuantidade">50</span></label><input type="range" class="form-range" min="10" max="150" step="5" id="rangeQuantidade"></div>
                                <div class="col-md-6"><label for="rangeVelocidade" class="form-label">(BETA) Velocidade: <span id="labelVelocidade">1.0x</span></label><input type="range" class="form-range" min="0.2" max="3.0" step="0.1" id="rangeVelocidade"></div>
                                <div class="col-12 mt-4"><div class="form-check form-switch"><input class="form-check-input dev-feature" type="checkbox" id="switchCompactMode"><label class="form-check-label" for="switchCompactMode">Modo Compacto</label></div></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="operacoes">
                            <p class="text-center text-muted">Esta se√ß√£o est√° em desenvolvimento.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary" id="btnSalvarConfigs"><i class="bi bi-save-fill me-2"></i>Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalDev" tabindex="-1" aria-labelledby="modalDevLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body">
                    <i class="bi bi-tools fs-1 text-warning mb-3"></i>
                    <h5 id="modalDevLabel">Em Desenvolvimento</h5>
                    <p class="mb-4">Este recurso estar√° dispon√≠vel em breve!</p>
                    <button class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="configToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">Configura√ß√µes salvas com sucesso! ‚úÖ</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>


    <div class="modal fade" id="liaModal" tabindex="-1" aria-labelledby="liaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
                        style="position: absolute; top: 20px; right: 20px; z-index: 4;"></button>
                
                <div class="modal-body">
                    <div id="liaResponseContainer" class="lia-response-container">
                        </div>

                    <div class="lia-input-area">
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col"><h5 class="modal-title" id="liaModalLabel">ü§ñ Fale com a Lia</h5></div>
                            <div class="col-auto">
                                <label for="liaModelSelector" class="form-label small mb-0 visually-hidden">Modelo:</label>
                                <select class="form-select form-select-sm" id="liaModelSelector">
                                    <option value="groq-70b" selected>Groq (Llama 3 70b)</option>
                                    <option value="groq-8b">Groq (Llama 3 8b)</option>
                                    <option value="gemini">Gemini (1.5 Flash)</option>
                                    <option value="kimi">Moonshot Kimi (Instruct)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-wrapper" style="position: relative;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="liaUserQuestion" placeholder="Pergunte ou use @ para focar em um m√≥dulo...">
                                
                                <button class="btn btn-outline-secondary" type="button" id="liaModulesHelperBtn" title="Mencionar m√≥dulo">
                                    <i class="bi bi-at"></i>
                                </button>
                                
                                <button class="btn btn-primary" id="liaAskButton" type="button">
                                    <span id="liaSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>

                            <div id="liaModulesList" class="list-group" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; z-index: 10; max-height: 160px; overflow-y: auto; margin-bottom: 0.5rem; box-shadow: 0 -4px 15px rgba(0,0,0,0.1);">
                                </div>
                        </div>

                        {% if can_view_tecnico %}
                            <div id="context-info-wrapper" class="mt-2" style="display: none;">
                                </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if can_view_tools_in_development %}
    <div class="floating-lia-btn" 
        data-bs-toggle="modal" 
        data-bs-target="#liaModal" 
        title="Perguntar √† Lia"
        data-proactive-module-name="{{ proactive_module_name or '' }}"
        data-proactive-module-id="{{ proactive_module_id or '' }}">
        <i class="bi bi-stars"></i>
    </div>
    {% endif %}
    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.5/viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
    // Script principal unificado para melhor organiza√ß√£o e performance.
    document.addEventListener('DOMContentLoaded', () => {
        // --- INST√ÇNCIAS E ELEMENTOS ---
        const devModal = new bootstrap.Modal(document.getElementById('modalDev'));
        const configToast = bootstrap.Toast.getOrCreateInstance(document.getElementById('configToast'));
        const highlightStyle = document.getElementById('highlight-theme-style');
        const body = document.body;

        const ui = {
            selectTema: document.getElementById('selectTema'),
            fontSize: document.getElementById('fontSize'),
            switchCompactMode: document.getElementById('switchCompactMode'),
            selectAnimacao: document.getElementById('selectAnimacao'),
            rangeQuantidade: document.getElementById('rangeQuantidade'),
            labelQuantidade: document.getElementById('labelQuantidade'),
            rangeVelocidade: document.getElementById('rangeVelocidade'),
            labelVelocidade: document.getElementById('labelVelocidade'),
            btnSalvarConfigs: document.getElementById('btnSalvarConfigs')
        };
        
        // --- FUN√á√ïES DE CONFIGURA√á√ÉO ---
        const applyTheme = (theme) => {
            const isDark = (theme === 'dark') || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            body.classList.toggle('theme-dark', isDark);
            highlightStyle.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github${isDark ? '-dark' : ''}.min.css`;
        };

        const applyFontSize = (size) => {
            body.style.setProperty('--font-size-base', size);
        };

        const applyBgAnimation = (mode) => {
            if (typeof window.mudarAnimacao === 'function') {
                window.mudarAnimacao(mode);
            }
        };

        // --- CARREGAMENTO INICIAL DAS CONFIGS ---
        const loadSettings = () => {
            const settings = {
                theme: localStorage.getItem('ld_theme') || 'light',
                fontSize: localStorage.getItem('ld_fontSize') || '1rem',
                bgAnimation: localStorage.getItem('ld_bgAnimation') || 'colisao',
                bgQuantity: localStorage.getItem('ld_bg_quantity') || '50',
                bgSpeed: localStorage.getItem('ld_bg_speed') || '1.0'
            };
            
            applyTheme(settings.theme);
            applyFontSize(settings.fontSize);
            applyBgAnimation(settings.bgAnimation);

            // Preenche os inputs do modal
            if (ui.selectTema) { // Verifica se os elementos existem antes de us√°-los
                ui.selectTema.value = settings.theme;
                ui.fontSize.value = settings.fontSize;
                ui.selectAnimacao.value = settings.bgAnimation;
                ui.rangeQuantidade.value = settings.bgQuantity;
                ui.labelQuantidade.textContent = settings.bgQuantity;
                ui.rangeVelocidade.value = settings.bgSpeed;
                ui.labelVelocidade.textContent = `${settings.bgSpeed}x`;
            }
            
            // Ativa highlight.js e Viewer.js
            hljs.highlightAll();
            const viewerEl = document.getElementById('main-content');
            if (viewerEl) {
                new Viewer(viewerEl, {
                    filter(image) { return image.parentElement.classList.contains('modulo-conteudo'); }, // Visualizar apenas imagens no conte√∫do
                    toolbar: true, navbar: false, title: false, movable: true, zoomable: true,
                    rotatable: false, scalable: false, transition: true, fullscreen: true,
                });
            }
        };
        
        // --- EVENT LISTENERS ---
        if(ui.btnSalvarConfigs) {
            ui.btnSalvarConfigs.addEventListener('click', () => {
                const newSettings = { theme: ui.selectTema.value, fontSize: ui.fontSize.value, bgAnimation: ui.selectAnimacao.value, bgQuantity: ui.rangeQuantidade.value, bgSpeed: ui.rangeVelocidade.value };
                Object.entries(newSettings).forEach(([key, value]) => { localStorage.setItem(`ld_${key}`, value); });
                localStorage.setItem('ld_bg_quantity', newSettings.bgQuantity);
                localStorage.setItem('ld_bg_speed', newSettings.bgSpeed);
                applyTheme(newSettings.theme);
                applyFontSize(newSettings.fontSize);
                applyBgAnimation(newSettings.bgAnimation);
                configToast.show();
                bootstrap.Modal.getInstance(document.getElementById('modalConfiguracoes')).hide();
            });

            // Sliders de range
            ui.rangeQuantidade.addEventListener('input', e => ui.labelQuantidade.textContent = e.target.value);
            ui.rangeVelocidade.addEventListener('input', e => ui.labelVelocidade.textContent = `${e.target.value}x`);
        }

        // Gatilho para features em desenvolvimento
        document.querySelectorAll('.dev-feature').forEach(el => {
            const eventType = el.type === 'checkbox' ? 'change' : 'click';
            el.addEventListener(eventType, (e) => {
                if ( (el.type === 'checkbox' && e.target.checked) || (el.type !== 'checkbox') ) {
                    e.preventDefault();
                    e.stopPropagation();
                    devModal.show();
                    if (el.type === 'checkbox') e.target.checked = false; // Desfaz a a√ß√£o
                    if(el.hasAttribute('data-bs-toggle')) {
                        const previousTab = document.querySelector('.nav-tabs .nav-link.active');
                        if(previousTab) bootstrap.Tab.getOrCreateInstance(previousTab).show();
                    }
                }
            });
        });

        // --- INICIALIZA√á√ÉO ---
        loadSettings();
    });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const liaModal = document.getElementById('liaModal');
        if (!liaModal) return;

        // --- SELETORES DE ELEMENTOS ---
        const liaFloatingBtn = document.querySelector('.floating-lia-btn');
        const askButton = document.getElementById('liaAskButton');
        const userQuestionInput = document.getElementById('liaUserQuestion');
        const modelSelector = document.getElementById('liaModelSelector');
        const responseContainer = document.getElementById('liaResponseContainer');
        const spinner = document.getElementById('liaSpinner');
        const sendIcon = askButton.querySelector('.bi-send-fill');
        const modulesHelperBtn = document.getElementById('liaModulesHelperBtn');
        const modulesListDiv = document.getElementById('liaModulesList');
        const contextInfoWrapper = document.getElementById('context-info-wrapper');

        // ==========================================================
        // === L√ìGICA DO ASSISTENTE PROATIVO ==========================
        // ==========================================================
        const proactiveModuleName = liaFloatingBtn ? liaFloatingBtn.dataset.proactiveModuleName : null;
        const proactiveModuleId = liaFloatingBtn ? liaFloatingBtn.dataset.proactiveModuleId : null;

        if (liaFloatingBtn && proactiveModuleName && proactiveModuleId) {
            liaFloatingBtn.classList.add('lia-proactive');
        }
        // ========================================================
        // === FIM DA L√ìGICA DO ASSISTENTE PROATIVO =================
        // ========================================================

        // --- L√ìGICA DE AUTOCOMPLETE DE M√ìDULOS ---
        let modulesCache = [];
        let isListVisible = false;

        const fetchModules = async () => {
            if (modulesCache.length > 0) return modulesCache;
            try {
                const response = await fetch("{{ url_for('ia_bp.get_modules_list') }}");
                if (!response.ok) return [];
                const data = await response.json();
                modulesCache = data.modules;
                return modulesCache;
            } catch (error) {
                console.error("Erro ao buscar lista de m√≥dulos:", error);
                return [];
            }
        };

        const showModulesList = (filter = '') => {
            fetchModules().then(modules => {
                const filteredModules = modules.filter(m => m.toLowerCase().includes(filter.toLowerCase()));
                if (filteredModules.length === 0) {
                    hideModulesList();
                    return;
                }

                modulesListDiv.innerHTML = '';
                filteredModules.forEach(module => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action py-2 px-3';
                    item.textContent = `@${module}`;
                    item.onclick = (e) => {
                        e.preventDefault();
                        const currentText = userQuestionInput.value;
                        const atIndex = currentText.lastIndexOf('@');
                        userQuestionInput.value = currentText.substring(0, atIndex) + `@${module} `;
                        hideModulesList();
                        userQuestionInput.focus();
                    };
                    modulesListDiv.appendChild(item);
                });
                modulesListDiv.style.display = 'block';
                isListVisible = true;
            });
        };

        const hideModulesList = () => {
            modulesListDiv.style.display = 'none';
            isListVisible = false;
        };

        // NEW: Vari√°veis para armazenar dados da √∫ltima resposta da IA para feedback
        let lastAiResponseData = {
            response_id: null,
            user_id: null,
            user_question: null,
            model_used: null,
            context_sources_list: []
        };

        // --- L√ìGICA PRINCIPAL DO CHAT ---
        const removeWelcomeMessage = () => {
            const welcome = responseContainer.querySelector('.alert-welcome');
            if (welcome) welcome.remove();
        };

        const handleAsk = async () => {
            const userQuestion = userQuestionInput.value;
            if (!userQuestion.trim()) return;

            removeWelcomeMessage();
            if (contextInfoWrapper) contextInfoWrapper.style.display = 'none';

            spinner.style.display = 'inline-block';
            sendIcon.style.display = 'none';
            askButton.disabled = true;
            userQuestionInput.disabled = true;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'lia-message user-message';
            userMessageDiv.textContent = userQuestion;
            responseContainer.appendChild(userMessageDiv);
            responseContainer.scrollTop = responseContainer.scrollHeight;

            userQuestionInput.value = '';

            try {
                const response = await fetch("{{ url_for('ia_bp.ask_llm_api') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_question: userQuestion,
                        selected_model: modelSelector.value
                    }),
                });

                const data = await response.json();
                const answerDiv = document.createElement('div');
                answerDiv.className = 'lia-message';

                if (response.ok) {
                    answerDiv.innerHTML = marked.parse(data.answer);

                    // NEW: Atualiza lastAiResponseData com os dados da resposta atual
                    lastAiResponseData.response_id = data.response_id;
                    lastAiResponseData.user_id = data.user_id;
                    lastAiResponseData.user_question = data.original_user_question; // From backend
                    lastAiResponseData.model_used = data.model_used; // From backend
                    lastAiResponseData.context_sources_list = data.context_files; // Assuming context_files is the same as context_sources_list for now

                    // Adiciona a se√ß√£o de feedback ap√≥s a resposta da IA
                    const feedbackHtml = `
                        <div class="feedback-section mt-3">
                            <small>Esta resposta foi √∫til?</small>
                            <div class="feedback-buttons mt-2">
                                <button class="btn btn-outline-success btn-sm feedback-good-btn">üëç Sim</button>
                                <button class="btn btn-outline-danger btn-sm feedback-bad-btn">üëé N√£o</button>
                            </div>
                            <div class="mt-3 feedback-comment-area" style="display: none;">
                                <textarea class="form-control" rows="2" placeholder="Opcional: Deixe um coment√°rio para nos ajudar a melhorar..."></textarea>
                                <button class="btn btn-primary btn-sm mt-2 submit-comment-btn">Enviar Coment√°rio</button>
                            </div>
                            <div class="mt-2 feedback-message"></div>
                        </div>
                    `;
                    answerDiv.innerHTML += feedbackHtml; // Adiciona o feedback ao conte√∫do da resposta

                    if (contextInfoWrapper && data.context_files && data.context_files.length > 0) {
                        const collapseId = `liaContextCollapse-${Date.now()}`;
                        const filesList = data.context_files.map(file => `<li class="list-group-item">${file}</li>`).join('');
                        contextInfoWrapper.innerHTML = `
                            <a class="btn-context" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false">
                                Fontes utilizadas <i class="bi bi-chevron-down ms-1"></i>
                            </a>
                            <div class="collapse" id="${collapseId}">
                                <ul class="list-group list-group-flush mt-2">${filesList}</ul>
                            </div>
                        `;
                        contextInfoWrapper.style.display = 'block';
                    }
                } else {
                    answerDiv.classList.add('bg-danger', 'text-white');
                    answerDiv.innerHTML = `<strong>Erro:</strong> ${data.error}`;
                    // NEW: Limpa lastAiResponseData em caso de erro
                    lastAiResponseData = { response_id: null, user_id: null, user_question: null, model_used: null, context_sources_list: [] };
                }
                responseContainer.appendChild(answerDiv);

            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'lia-message bg-danger text-white';
                errorDiv.innerHTML = '<strong>Erro de conex√£o.</strong> Verifique o console do servidor.';
                responseContainer.appendChild(errorDiv);
                // NEW: Limpa lastAiResponseData em caso de erro de conex√£o
                lastAiResponseData = { response_id: null, user_id: null, user_question: null, model_used: null, context_sources_list: [] };
            } finally {
                spinner.style.display = 'none';
                sendIcon.style.display = 'inline-block';
                askButton.disabled = false;
                userQuestionInput.disabled = false;
                userQuestionInput.focus();
                responseContainer.scrollTop = responseContainer.scrollHeight;
            }
        };

        // NEW: Fun√ß√£o para enviar feedback
        async function submitFeedback(feedbackSectionElement, rating, comment = null) {
            // Usa os dados da √∫ltima resposta armazenados
            const responseId = lastAiResponseData.response_id;
            const userId = lastAiResponseData.user_id;
            const userQuestion = lastAiResponseData.user_question;
            const modelUsed = lastAiResponseData.model_used;
            const contextSources = lastAiResponseData.context_sources_list; // Passa a lista diretamente

            const feedbackMessageDiv = feedbackSectionElement.querySelector('.feedback-message');
            const feedbackCommentArea = feedbackSectionElement.querySelector('.feedback-comment-area');
            const feedbackGoodBtn = feedbackSectionElement.querySelector('.feedback-good-btn');
            const feedbackBadBtn = feedbackSectionElement.querySelector('.feedback-bad-btn');
            const submitCommentBtn = feedbackSectionElement.querySelector('.submit-comment-btn');


            if (!responseId || !userId) {
                feedbackMessageDiv.innerHTML = '<p class="text-danger">Erro: ID da resposta ou do usu√°rio n√£o dispon√≠vel.</p>';
                return;
            }

            // Desabilitar bot√µes para evitar m√∫ltiplas submiss√µes
            feedbackGoodBtn.disabled = true;
            feedbackBadBtn.disabled = true;
            if (submitCommentBtn) submitCommentBtn.disabled = true;

            try {
                const response = await fetch("{{ url_for('ia_bp.submit_feedback_api') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        response_id: responseId,
                        user_id: userId,
                        rating: rating,
                        comment: comment,
                        user_question: userQuestion, // NOVO
                        model_used: modelUsed,       // NOVO
                        context_sources: contextSources // NOVO
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    feedbackMessageDiv.innerHTML = `<p class="text-success">${data.message}</p>`;
                    // Esconde a se√ß√£o de feedback completa ap√≥s o envio do feedback ou do coment√°rio
                    if (comment !== null || rating === 1) { // Se um coment√°rio foi enviado ou feedback positivo
                        feedbackSectionElement.style.display = 'none';
                    } else if (rating === 0 && comment === null) { // Se feedback negativo inicial sem coment√°rio
                        feedbackMessageDiv.innerHTML = '<p class="text-info">Por favor, adicione um coment√°rio para nos ajudar a melhorar.</p>';
                        if (submitCommentBtn) submitCommentBtn.disabled = false; // Reabilita o bot√£o de enviar coment√°rio
                    }
                } else {
                    feedbackMessageDiv.innerHTML = `<p class="text-danger">Erro: ${data.error}</p>`;
                    // Reabilita os bot√µes em caso de erro, exceto se j√° foi dado um feedback definitivo
                    if (!(comment !== null || rating === 1)) {
                         feedbackGoodBtn.disabled = false;
                         feedbackBadBtn.disabled = false;
                    }
                    if (rating === 0 && comment === null) {
                         if (submitCommentBtn) submitCommentBtn.disabled = false;
                    }
                }
            } catch (error) {
                feedbackMessageDiv.innerHTML = `<p class="text-danger">Erro de conex√£o ao enviar feedback.</p>`;
                // Reabilita os bot√µes em caso de erro de conex√£o
                if (!(comment !== null || rating === 1)) {
                    feedbackGoodBtn.disabled = false;
                    feedbackBadBtn.disabled = false;
                }
                if (rating === 0 && comment === null) {
                    if (submitCommentBtn) submitCommentBtn.disabled = false;
                }
            }
        }

        // NEW: Event delegation for feedback buttons
        // Usamos delega√ß√£o de eventos no responseContainer para lidar com bot√µes de feedback adicionados dinamicamente
        responseContainer.addEventListener('click', (e) => {
            const target = e.target;
            // Encontra a se√ß√£o de feedback mais pr√≥xima para o bot√£o clicado
            const feedbackSectionElement = target.closest('.feedback-section');

            if (!feedbackSectionElement) return; // N√£o √© um clique relacionado a feedback

            // Opcional: Para garantir que o feedback √© sempre para a √∫ltima resposta da IA
            // Note: Esta verifica√ß√£o garante que o feedback seja apenas para a resposta mais recente.
            // Se voc√™ quiser permitir feedback em mensagens anteriores, remova este bloco.
            const allLiaMessages = responseContainer.querySelectorAll('.lia-message:not(.user-message)');
            const lastAiMessageDiv = allLiaMessages[allLiaMessages.length - 1]; // Pega a √∫ltima mensagem da Lia
            if (!lastAiMessageDiv || !lastAiMessageDiv.contains(feedbackSectionElement)) {
                console.warn('Bot√£o de feedback clicado para uma resposta antiga. Apenas a resposta mais recente pode ser avaliada.');
                return;
            }


            if (target.classList.contains('feedback-good-btn')) {
                feedbackSectionElement.dataset.lastSubmittedRating = 1; // Armazena para poss√≠vel coment√°rio posterior
                submitFeedback(feedbackSectionElement, 1);
            } else if (target.classList.contains('feedback-bad-btn')) {
                feedbackSectionElement.dataset.lastSubmittedRating = 0; // Armazena para poss√≠vel coment√°rio posterior
                const commentArea = feedbackSectionElement.querySelector('.feedback-comment-area');
                commentArea.style.display = 'block'; // Mostra a √°rea de coment√°rio
                submitFeedback(feedbackSectionElement, 0);
            } else if (target.classList.contains('submit-comment-btn')) {
                const commentInput = feedbackSectionElement.querySelector('textarea');
                const comment = commentInput.value;
                const lastRating = parseInt(feedbackSectionElement.dataset.lastSubmittedRating, 10);
                submitFeedback(feedbackSectionElement, lastRating, comment);
            }
        });

        // --- EVENT LISTENERS ---
        userQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleAsk();
            }
        });

        askButton.addEventListener('click', handleAsk);

        modulesHelperBtn.addEventListener('click', () => {
            if (isListVisible) hideModulesList();
            else {
                const val = userQuestionInput.value;
                userQuestionInput.value += (val.length > 0 && !val.endsWith(' ')) ? ' @' : '@';
                userQuestionInput.focus();
                showModulesList();
            }
        });

        userQuestionInput.addEventListener('input', () => {
            const text = userQuestionInput.value;
            const atIndex = text.lastIndexOf('@');
            if (atIndex !== -1 && !text.includes(' ', atIndex)) {
                showModulesList(text.substring(atIndex + 1));
            } else {
                hideModulesList();
            }
        });

        document.addEventListener('click', (e) => {
            if (!modulesListDiv.contains(e.target) && e.target !== userQuestionInput && e.target !== modulesHelperBtn && !modulesHelperBtn.contains(e.target)) {
                hideModulesList();
            }
        });

        // ATUALIZADO: L√≥gica de abertura do Modal
        liaModal.addEventListener('shown.bs.modal', () => {
            userQuestionInput.focus();

            // Exibe a mensagem de boas-vindas apenas se o chat estiver vazio.
            if (responseContainer.children.length === 0 || responseContainer.textContent.trim() === '') {
                let welcomeMessage = '';
                // Usa o NOME do m√≥dulo para a mensagem
                if (proactiveModuleName) {
                    const formattedModuleName = proactiveModuleName.replace(/-/g, ' ');
                    welcomeMessage = `<div class="alert alert-light my-2 alert-welcome">Ol√°! üëã Vi que voc√™ est√° na p√°gina de <strong>${formattedModuleName}</strong>. Posso ajudar com alguma d√∫vida sobre este processo?</div>`;
                } else {
                    welcomeMessage = '<div class="alert alert-light my-2 alert-welcome">Ol√°! üëã Sou a Lia, sua assistente de conhecimento.</div>';
                }
                responseContainer.innerHTML = welcomeMessage;
                // NEW: Reseta lastAiResponseData ao abrir o modal se o chat estiver vazio
                lastAiResponseData = { response_id: null, user_id: null, user_question: null, model_used: null, context_sources_list: [] };
            }

            // Pr√©-preenche o input com o @ID do m√≥dulo
            if (proactiveModuleId) {
                if (!userQuestionInput.value.includes(`@${proactiveModuleId}`)) {
                    userQuestionInput.value = `@${proactiveModuleId} `;
                }
            }
        });
    });
    </script>
        {% endblock %}
</body>
</html>