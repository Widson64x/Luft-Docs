{% extends "base.html" %}
{% block title %}Editar Módulo: {{ modulo.nome }}{% endblock %}

{% block page_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/Editor/Editor_Module.css') }}">
  <style>
    /* UI de relacionados */
    .rel-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; background:var(--bs-gray-200); font-size:.85rem; margin:.25rem .35rem .25rem 0 }
    .rel-pill .remove { cursor:pointer; border:none; background:transparent; font-size:1rem; line-height:1; padding:0 }
    .rel-select-btn { white-space:nowrap }
    .rel-counter { font-size:.85rem; color:var(--bs-secondary) }
    .rel-search { position:sticky; top:0; background:#fff; z-index:1; padding-bottom:.5rem }
    .rel-list { max-height:55vh; overflow:auto }
    .rel-item { padding:.35rem .5rem; border-radius:.5rem }
    .rel-item:hover { background:var(--bs-gray-100) }
    .icon-grid-btn.selected { outline:2px solid var(--bs-primary) }
    #icon-preview-box { width:44px; height:44px; display:flex; align-items:center; justify-content:center; border:1px dashed var(--bs-secondary); border-radius:.5rem; cursor:pointer }
    #icon-preview-box i { font-size:22px }
    .editor-toolbar-btns { display:flex; gap:.5rem; padding:.5rem 0 }
    .page-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem }
    .main-form-card { background:var(--bs-body-bg); border:1px solid var(--bs-border-color); border-radius:.75rem; padding:1rem 1.25rem }
    .text_place { color:var(--bs-secondary) }
    .theme-dark .rel-pill { background:#2b2f33 }
    .theme-dark .rel-item:hover { background:#1e2327 }
    .theme-dark .rel-search { background:var(--bs-body-bg) }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <form method="post" id="editor-form">
    <input type="hidden" name="token" value="{{ token }}">
    <input type="hidden" name="doc_content" id="doc_content_input">
    <input type="hidden" name="tech_content" id="tech_content_input">
    <!-- valor final CSV -->
    <input type="hidden" name="relacionados" id="inputRelacionados" value="{{ modulo.relacionados|join(', ') }}">

    <div class="page-header">
      <h1 class="page-title"><i class="bi bi-pencil-square"></i>Editar Módulo: {{ modulo.nome }}</h1>
      <div class="btn-group" role="group">
        <button type="submit" class="btn btn-primary btn-lg px-4">
          <i class="bi bi-save me-2"></i>Salvar Alterações
        </button>
        <a href="{{ url_for('editor.editor_index', token=token) }}" class="btn btn-outline-secondary btn-lg px-4">
          <i class="bi bi-x-circle me-2"></i>Cancelar
        </a>
      </div>
    </div>

    <div class="main-form-card">
      {% if pendente %}
        <div class="alert alert-warning d-flex align-items-center mb-4">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div>Há uma edição pendente para a <b>documentação do usuário</b>. Salvar agora irá sobrescrever a alteração pendente.</div>
        </div>
      {% endif %}
      {% if pendente_tech %}
        <div class="alert alert-warning d-flex align-items-center mb-4">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div>Há uma edição pendente para a <b>documentação técnica</b>. Salvar agora irá sobrescrever a alteração pendente.</div>
        </div>
      {% endif %}

      <div class="row g-4">
        <div class="col-lg-4">
          <h5 class="mb-3 text-primary">Informações Gerais</h5>
          <div class="mb-3">
            <label for="inputId" class="form-label">ID do Módulo</label>
            <input type="text" class="form-control" id="inputId" name="id" value="{{ modulo.id }}" readonly>
          </div>
          <div class="mb-3">
            <label for="inputNome" class="form-label">Nome do Módulo</label>
            <input type="text" class="form-control" id="inputNome" name="nome" value="{{ modulo.nome }}" required>
          </div>
          <div class="mb-3">
            <label for="inputDescricao" class="form-label">Descrição Curta</label>
            <textarea class="form-control" id="inputDescricao" name="descricao" style="height: 100px;">{{ modulo.descricao }}</textarea>
          </div>

          <hr class="my-4">

          <h5 class="mb-3 text-primary">Organização</h5>
          <div class="mb-3">
            <label class="form-label">Ícone</label>
            <div class="d-flex align-items-center gap-3">
              <div id="icon-preview-box" data-bs-toggle="modal" data-bs-target="#iconModal">
                <i class="bi {{ modulo.icone or 'bi-app' }}"></i>
              </div>
              <input type="text" class="form-control" id="inputIcone" name="icone" value="{{ modulo.icone }}" readonly style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#iconModal">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputPalavras" class="form-label">Palavras-chave</label>
            <input type="text" class="form-control" id="inputPalavras" name="palavras_chave" value="{{ modulo.palavras_chave|join(', ') }}" placeholder="Separadas por vírgula">
            <small class="form-text text-muted">Ex: cliente, cadastro, novo</small>
          </div>

          <!-- NOVO: UI Relacionados -->
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <label class="form-label m-0">Módulos Relacionados</label>
            <span class="rel-counter" id="relCounter">0 selecionados</span>
          </div>
          <div class="mb-2" id="relacionadosPills"></div>
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary rel-select-btn" data-bs-toggle="modal" data-bs-target="#relModal">
              <i class="bi bi-diagram-3"></i> Selecionar módulos
            </button>
            <button type="button" id="btnLimparRel" class="btn btn-outline-secondary ms-2">
              Limpar tudo
            </button>
          </div>
        </div>

        <div class="col-lg-8">
          <ul class="nav nav-tabs" id="editorTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="user-doc-tab" data-bs-toggle="tab" data-bs-target="#doc-user-pane" type="button" role="tab" aria-controls="doc-user-pane" aria-selected="true">
                <i class="bi bi-person me-2"></i>Conteúdo para o Usuário
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tech-doc-tab" data-bs-toggle="tab" data-bs-target="#doc-tech-pane" type="button" role="tab" aria-controls="doc-tech-pane" aria-selected="false">
                <i class="bi bi-code-slash me-2"></i>Documentação Técnica
              </button>
            </li>
          </ul>

          <div class="tab-content" id="editorTabsContent">
            <div class="tab-pane fade show active" id="doc-user-pane" role="tabpanel" aria-labelledby="user-doc-tab">
              <div class="editor-toolbar-btns" id="toolbar-user"></div>
              <div id="editor-user"></div>
            </div>
            <div class="tab-pane fade" id="doc-tech-pane" role="tabpanel" aria-labelledby="tech-doc-tab">
              <div class="editor-toolbar-btns" id="toolbar-tech"></div>
              <div id="editor-tech"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal Ícones -->
<div class="modal fade" id="iconModal" tabindex="-1" aria-labelledby="iconModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="iconModalLabel">Escolha um Ícone</h5>
        <input type="text" class="form-control ms-4" id="iconSearch" placeholder="Buscar ícone...">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="iconGrid" class="row row-cols-4 row-cols-sm-6 row-cols-md-8 row-cols-lg-10 g-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Relacionados -->
<div class="modal fade" id="relModal" tabindex="-1" aria-labelledby="relModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="relModalLabel">Selecionar Módulos Relacionados</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary ms-3" id="btnToggleAll">Selecionar tudo</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="rel-search mb-2">
          <input type="text" id="relSearch" class="form-control" placeholder="Buscar por nome ou ID...">
        </div>
        <div class="rel-list" id="relList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Aplicar</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = '{{ token }}';
  const BASE_PREFIX = '/luft-docs';
  let allIcons = [];
  let allModules = [];
  let selectedRel = new Set({{ modulo.relacionados|tojson }});

  const docInitial = {{ doc_content|tojson }};
  const techInitial = {{ tech_content|tojson }};

  function withPrefix(path) {
    if (/^https?:\/\//i.test(path)) return path;
    
    // Normaliza o caminho para garantir que comece com /
    const safePath = path.startsWith('/') ? path : '/' + path;
    
    // CORREÇÃO: Se já começar com o prefixo, retorna como está para evitar duplicação
    if (safePath.startsWith(BASE_PREFIX)) {
      return safePath;
    }
    
    return `${BASE_PREFIX}${safePath}`;
  }

  /* ---------- ToastUI Editors ---------- */
  let userEditor, techEditor;
  function initializeEditors() {
    if (userEditor) userEditor.destroy();
    if (techEditor) techEditor.destroy();
    /*
    * Por que a gente destrói e recria o editor toda vez que o tema muda?
    * Porque o TUI Editor odeia mudanças de tema em tempo real.
    * A gente tentou ser legal. Não deu.
    * Na base do "desliga e liga" funciona.
    */
    const isDark = document.body.classList.contains('theme-dark');
    const editorTheme = isDark ? 'dark' : 'light';
    const commonEditorOptions = {
      initialEditType: 'markdown',
      previewStyle: 'tab',
      height: '700px',
      usageStatistics: false,
      theme: editorTheme,
      markdown: { breaks: true, linkify: true, html: true },
      hooks: {
        addImageBlobHook: (blob, callback) => {
          const fd = new FormData();
          fd.append('file', blob);
          fetch(withPrefix(`{{ url_for("editor.upload_image", modulo_id=modulo.id) }}?token=${token}`), { method:'POST', body:fd })
            .then(res => res.json())
            .then(data => callback(withPrefix(data.url), withPrefix(data.url)))
            .catch(() => alert('Erro ao enviar imagem!'));
        }
      }
    };
    userEditor = new toastui.Editor({ ...commonEditorOptions, el: document.querySelector('#editor-user'), initialValue: docInitial });
    techEditor = new toastui.Editor({ ...commonEditorOptions, el: document.querySelector('#editor-tech'), initialValue: techInitial });
    attachCustomButtons(userEditor, 'toolbar-user');
    attachCustomButtons(techEditor, 'toolbar-tech');
  }
  function attachCustomButtons(editor, toolbarId) {
    const toolbar = document.getElementById(toolbarId);
    toolbar.innerHTML = '';
    const attachBtn = document.createElement('button');
    attachBtn.type = 'button';
    attachBtn.className = 'btn btn-outline-secondary btn-sm';
    attachBtn.innerHTML = '<i class="bi bi-paperclip"></i> Anexar Arquivo';
    attachBtn.onclick = () => uploadAttachment(editor);

    const videoBtn = document.createElement('button');
    videoBtn.type = 'button';
    videoBtn.className = 'btn btn-outline-danger btn-sm';
    videoBtn.innerHTML = '<i class="bi bi-camera-video"></i> Inserir Vídeo';
    videoBtn.onclick = () => uploadVideo(editor);

    const wikilinkBtn = document.createElement('button');
    wikilinkBtn.type = 'button';
    wikilinkBtn.className = 'btn btn-outline-info btn-sm';
    wikilinkBtn.innerHTML = '<i class="bi bi-link-45deg"></i> Wikilink';
    wikilinkBtn.onclick = () => {
      let palavra = editor.getSelectedText() || prompt('Digite a palavra para criar o link:');
      if (palavra) editor.insertText(`[[${palavra}]]`);
    };
    toolbar.appendChild(attachBtn);
    toolbar.appendChild(videoBtn);
    toolbar.appendChild(wikilinkBtn);
  }
  function uploadAttachment(editor) {
    const inp = document.createElement('input'); inp.type = 'file';
    inp.onchange = () => {
      const file = inp.files[0]; const fd = new FormData(); fd.append('file', file);
      fetch(withPrefix(`/editor/upload_anexo?token=${token}`), { method:'POST', body:fd })
        .then(res => res.json())
        .then(data => editor.insertText(`\n[${file.name}](${withPrefix(data.url)}&token=${token})\n`))
        .catch(() => alert('Erro ao enviar anexo!'));
    };
    inp.click();
  }
  function uploadVideo(editor) {
    const inp = document.createElement('input'); inp.type='file'; inp.accept='video/*';
    inp.onchange = () => {
      const file = inp.files[0]; const fd = new FormData(); fd.append('file', file);
      fetch(withPrefix(`/editor/upload_video/{{ modulo.id }}?token=${token}`), { method:'POST', body:fd })
        .then(res => res.json())
        .then(data => {
          if (data.url) {
            const tag = `<video width="100%" controls><source src="${withPrefix(data.url)}" type="${data.type}"></video>`;
            editor.insertText(`\n${tag}\n`);
          } else alert(data.error || 'Erro ao enviar vídeo!');
        })
        .catch(() => alert('Erro ao enviar vídeo!'));
    };
    inp.click();
  }

  /* ---------- Ícones ---------- */
  function renderIconGrid(filter = '') {
    const grid = document.getElementById('iconGrid');
    const selectedIcon = document.getElementById('inputIcone').value;
    grid.innerHTML = '';
    const filteredIcons = allIcons.filter(i => i.toLowerCase().includes(filter.toLowerCase()));
    filteredIcons.forEach(iconClass => {
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `<button type="button" class="btn btn-light icon-grid-btn ${iconClass === selectedIcon ? 'selected' : ''}" data-icon="${iconClass}" title="${iconClass}">
        <i class="bi ${iconClass}"></i></button>`;
      grid.appendChild(col);
    });
    grid.querySelectorAll('.icon-grid-btn').forEach(btn => {
      btn.onclick = function() {
        const iconClass = this.getAttribute('data-icon');
        document.getElementById('inputIcone').value = iconClass;
        document.querySelector('#icon-preview-box i').className = `bi ${iconClass}`;
        bootstrap.Modal.getInstance(document.getElementById('iconModal')).hide();
      };
    });
  }

  /* ---------- Relacionados ---------- */
  const pillsBox = document.getElementById('relacionadosPills');
  const relCounter = document.getElementById('relCounter');
  const relHidden = document.getElementById('inputRelacionados');

  function renderRelPills() {
    pillsBox.innerHTML = '';
    const byId = Object.fromEntries(allModules.map(m => [String(m.id), m]));
    [...selectedRel].forEach(id => {
      const mod = byId[String(id)];
      const name = mod ? `${mod.nome}` : id;
      const pill = document.createElement('span');
      pill.className = 'rel-pill';
      pill.innerHTML = `<i class="bi bi-node-plus"></i> ${name} <button class="remove" title="Remover" data-id="${id}">&times;</button>`;
      pillsBox.appendChild(pill);
    });
    pillsBox.querySelectorAll('.remove').forEach(btn => {
      btn.onclick = () => { selectedRel.delete(btn.getAttribute('data-id')); syncRelState(); renderRelPills(); markChecks(); };
    });
    updateRelHiddenAndCounter();
  }
  function updateRelHiddenAndCounter() {
    relHidden.value = [...selectedRel].join(',').trim();
    const n = selectedRel.size;
    relCounter.textContent = n === 0 ? '0 selecionados' : `${n} selecionado${n>1?'s':''}`;
  }
  function filteredModules(term) {
    const t = term.trim().toLowerCase();
    if (!t) return allModules;
    return allModules.filter(m => String(m.id).toLowerCase().includes(t) || (m.nome || '').toLowerCase().includes(t));
  }
  function renderRelList(term='') {
    const list = document.getElementById('relList');
    const mods = filteredModules(term);
    list.innerHTML = '';
    mods.forEach(m => {
      const id = String(m.id);
      const checked = selectedRel.has(id) ? 'checked' : '';
      const el = document.createElement('div');
      el.className = 'rel-item form-check';
      el.innerHTML = `
        <input class="form-check-input rel-check" type="checkbox" value="${id}" id="rel_${id}" ${checked}>
        <label class="form-check-label ms-1" for="rel_${id}">
          <span class="fw-semibold">${m.nome}</span>
          <span class="text-muted"> · ${id}</span>
        </label>`;
      list.appendChild(el);
    });
    list.querySelectorAll('.rel-check').forEach(chk => {
      chk.onchange = () => {
        const id = chk.value;
        if (chk.checked) selectedRel.add(id); else selectedRel.delete(id);
        syncRelState();
      };
    });
  }
  function syncRelState() {
    updateRelHiddenAndCounter();
    renderRelPills();
  }
  function markChecks() {
    // re-aplicar checks conforme selectedRel após re-render
    const list = document.getElementById('relList');
    list.querySelectorAll('.rel-check').forEach(chk => {
      chk.checked = selectedRel.has(chk.value);
    });
  }

  document.getElementById('btnLimparRel').onclick = () => { selectedRel.clear(); syncRelState(); markChecks(); };
  document.getElementById('btnToggleAll').onclick = () => {
    const currentTerm = document.getElementById('relSearch').value || '';
    const mods = filteredModules(currentTerm);
    const allOn = mods.every(m => selectedRel.has(String(m.id)));
    if (allOn) mods.forEach(m => selectedRel.delete(String(m.id)));
    else mods.forEach(m => selectedRel.add(String(m.id)));
    syncRelState(); markChecks();
  };

  /* ---------- Eventos Modais ---------- */
  const iconModal = document.getElementById('iconModal');
  iconModal.addEventListener('shown.bs.modal', () => {
    document.getElementById('iconSearch').value = '';
    renderIconGrid();
    document.getElementById('iconSearch').focus();
  });
  document.getElementById('iconSearch').addEventListener('input', e => renderIconGrid(e.target.value.trim()));

  const relModal = document.getElementById('relModal');
  relModal.addEventListener('shown.bs.modal', () => {
    const search = document.getElementById('relSearch');
    search.value = '';
    renderRelList('');
    search.focus();
  });
  document.getElementById('relSearch').addEventListener('input', e => renderRelList(e.target.value));

  /* ---------- Submit ---------- */
  document.getElementById('editor-form').addEventListener('submit', e => {
    if (!document.getElementById('inputNome').value) {
      e.preventDefault(); alert('O campo "Nome do Módulo" é obrigatório!'); return;
    }
    document.getElementById('doc_content_input').value = userEditor.getMarkdown();
    document.getElementById('tech_content_input').value = techEditor.getMarkdown();
    // garante CSV atualizado
    relHidden.value = [...selectedRel].join(',');
  });

  /* ---------- Inits ---------- */
  initializeEditors();
  // Recreate editors ao trocar tema
  const observer = new MutationObserver(m => { if (m.some(x => x.attributeName === 'class')) initializeEditors(); });
  observer.observe(document.body, { attributes:true });

  // Carrega opções
  fetch(withPrefix(`/editor/options?token=${token}`))
    .then(r => r.json())
    .then(data => {
      allIcons = data.icons || [];
      allModules = data.modules || [];
      // Não permitir relacionar consigo mesmo
      const selfId = String({{ modulo.id|tojson }});
      allModules = allModules.filter(m => String(m.id) !== selfId);
      // normaliza selectedRel para string
      selectedRel = new Set([...selectedRel].map(String));
      syncRelState();
    })
    .catch(() => { allModules=[]; allIcons=[]; syncRelState(); });
});
</script>
{% endblock %}
